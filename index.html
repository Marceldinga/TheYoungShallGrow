<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>The Young Shall Grow – Njangi Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b1220; --panel:#111827; --card:#151c2f; --card2:#1b2440;
      --text:#e5e7eb; --muted:#9ca3af; --border:#253056;
      --green:#22c55e; --blue:#2a6adf; --danger:#ef4444;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(42,106,223,.35), transparent 60%),
                  radial-gradient(1000px 500px at 80% -20%, rgba(34,197,94,.25), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:22px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand h1{ margin:0; font-size:20px; letter-spacing:-.02em; }
    .brand p{ margin:0; color:var(--muted); font-size:13px; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid var(--border); border-radius:999px;
      background: rgba(17,24,39,.6);
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--danger); }
    .dot.ok{ background:var(--green); }

    .card{
      background: linear-gradient(180deg, rgba(27,36,64,.9), rgba(17,24,39,.7));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin-bottom:14px;
    }

    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
    .col-12{ grid-column: span 12; }
    .col-6{ grid-column: span 6; }
    @media (max-width: 980px){ .col-6{ grid-column: span 12; } }

    h2{ margin:0 0 10px; font-size:16px; color:var(--green); }
    h3{ margin:14px 0 8px; font-size:14px; color:#cfe7ff; font-weight:600; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:180px; }

    input, select{
      width:100%;
      padding:10px 11px;
      border-radius: 10px;
      border:1px solid var(--border);
      background: rgba(11,18,32,.65);
      color:var(--text);
      outline:none;
    }
    input::placeholder{ color:#7c879b; }

    button{
      width:100%;
      padding:10px 12px;
      border-radius: 10px;
      border:1px solid rgba(34,197,94,.35);
      background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(34,197,94,.75));
      color:#06210f;
      font-weight:700;
      cursor:pointer;
      transition: transform .08s ease, opacity .15s ease;
    }
    button:hover{ opacity:.92; }
    button:active{ transform: translateY(1px); }
    button.secondary{
      background: rgba(42,106,223,.18);
      border:1px solid rgba(42,106,223,.40);
      color:#dbeafe;
      font-weight:650;
    }
    button.danger{
      background: rgba(239,68,68,.18);
      border:1px solid rgba(239,68,68,.40);
      color:#fee2e2;
      font-weight:650;
    }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:8px; border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(17,24,39,.55);
      margin-bottom:14px;
    }
    .tab{
      padding:9px 12px;
      border-radius: 10px;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      font-weight:650;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(42,106,223,.45);
      background: rgba(42,106,223,.16);
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){ .kpis{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 520px){ .kpis{ grid-template-columns: 1fr; } }

    .kpi{
      border:1px solid var(--border);
      background: rgba(11,18,32,.55);
      border-radius: 14px;
      padding:12px;
    }
    .kpi .label{ color: var(--muted); font-size:12px; }
    .kpi .value{ margin-top:4px; font-size:18px; font-weight:800; letter-spacing:-.02em; }

    .muted{ color: var(--muted); font-size:13px; }

    .tableGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .tbox{
      grid-column: span 6;
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(11,18,32,.45);
      overflow:hidden;
      min-height: 260px;
      display:flex;
      flex-direction:column;
    }
    @media (max-width: 980px){ .tbox{ grid-column: span 12; } }

    .tboxHead{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(17,24,39,.55);
    }
    .tboxHead strong{ color:#dbeafe; font-size:13px; }
    .tboxBody{ overflow:auto; padding:10px 12px; max-height: 360px; }

    table{ width:100%; border-collapse:collapse; font-size:12px; }
    th, td{
      padding:8px 8px;
      border-bottom:1px solid rgba(37,48,86,.55);
      text-align:left;
      vertical-align:top;
      white-space:nowrap;
    }
    th{
      position:sticky; top:0;
      background: rgba(21,28,47,.95);
      color:#cfe7ff;
      z-index:1;
    }

    .hide{ display:none; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <h1>The Young Shall Grow – Njangi</h1>
        <p>Clean dashboard (Supabase handles all rules & totals)</p>
      </div>
      <div class="pill">
        <span id="statusDot" class="dot"></span>
        <span id="statusText" class="muted">Not logged in</span>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h2>Login</h2>
      <div class="grid">
        <div class="col-6"><input id="email" placeholder="Email"></div>
        <div class="col-6"><input id="password" type="password" placeholder="Password"></div>
        <div class="col-6"><button onclick="login()">Login</button></div>
        <div class="col-6"><button class="secondary" onclick="logout()">Logout</button></div>
        <div class="col-12"><div id="loginStatus" class="muted"></div></div>
      </div>
    </div>

    <!-- TABS -->
    <div id="appTabs" class="tabs hide">
      <button class="tab active" data-tab="overview" onclick="switchTab('overview')">Overview</button>
      <button class="tab" data-tab="member" onclick="switchTab('member')">Member</button>
      <button class="tab" data-tab="admin" id="adminTabBtn" onclick="switchTab('admin')">Admin</button>
      <button class="tab" data-tab="tables" onclick="switchTab('tables')">Tables</button>
    </div>

    <!-- OVERVIEW -->
    <div id="tab_overview" class="card hide">
      <h2>Overview</h2>
      <div class="kpis">
        <div class="kpi"><div class="label">Pot Amount</div><div class="value" id="potAmount">--</div></div>
        <div class="kpi"><div class="label">Pending Foundation Payments</div><div class="value" id="pendingFoundation">--</div></div>
        <div class="kpi"><div class="label">My Total Value</div><div class="value" id="myValue">--</div></div>
        <div class="kpi"><div class="label">My Member ID</div><div class="value" id="myMemberId">--</div></div>
        <div class="kpi">
  <div class="label">Total Foundation Payment</div>
  <div class="value" id="totalFoundationPayment">--</div>
</div>


        <div class="kpi"><div class="label">Total Loans</div><div class="value" id="totalLoans">--</div></div>
        <div class="kpi"><div class="label">Total Interest Generated</div><div class="value" id="totalInterest">--</div></div>
        <div class="kpi"><div class="label">Beneficiary Date (Bi-Weekly)</div><div class="value" id="beneficiaryDate">--</div></div>
        <div class="kpi"><div class="label">Role</div><div class="value" id="myRole">--</div></div>
      </div>

      <div style="margin-top:10px" class="muted">
        Tip: Click <b>Tables</b> to view all records your RLS allows. Admin can also insert using the Admin tab.
      </div>
    </div>

    <!-- MEMBER -->
    <div id="tab_member" class="card hide">
      <h2>Member Actions</h2>

      <h3>Request Loan</h3>
      <div class="row">
        <input id="loan_borrower" placeholder="Your Member ID (bigint)">
        <input id="loan_surety" placeholder="Surety Member ID (bigint)">
        <input id="loan_amount" type="number" placeholder="Amount">
      </div>
      <button onclick="requestLoan()">Request Loan</button>

      <h3 style="margin-top:16px;">Pay Interest (if you use it)</h3>
      <div class="row">
        <input id="pi_loan_id" placeholder="Loan ID (uuid)">
        <input id="pi_amount" type="number" placeholder="Amount">
      </div>
      <button class="secondary" onclick="payInterest()">Pay Interest</button>
    </div>

    <!-- ADMIN -->
    <div id="tab_admin" class="card hide">
      <h2>Admin Actions</h2>
      <div class="muted">Admin tab shows only if <b>is_admin()</b> returns true for your logged-in user.</div>

      <h3>Add Member</h3>
      <div class="row">
        <input id="m_name" placeholder="Name">
        <input id="m_email" placeholder="Email">
        <input id="m_phone" placeholder="Phone">
      </div>
      <button onclick="addMember()">Add Member</button>

      <h3>Add Contribution</h3>
      <div class="row">
        <input id="c_member" placeholder="Member ID (bigint)">
        <input id="c_amount" type="number" placeholder="Amount">
      </div>
      <button onclick="addContribution()">Add Contribution</button>

      <h3>Add Fine</h3>
      <div class="row">
        <input id="f_member" placeholder="Member ID (bigint)">
        <input id="f_amount" type="number" placeholder="Amount">
        <input id="f_reason" placeholder="Reason">
      </div>
      <button onclick="addFine()">Add Fine</button>

      <h3>Add Foundation Payment (Pending)</h3>
      <div class="row">
        <input id="fp_member" placeholder="Member ID (bigint)">
        <input id="fp_paid" type="number" placeholder="Amount Paid (optional)" value="0">
        <input id="fp_pending" type="number" placeholder="Amount Pending">
        <select id="fp_status">
          <option value="pending" selected>pending</option>
          <option value="paid">paid</option>
        </select>
      </div>
      <button onclick="addFoundationPending()">Add Foundation Payment</button>

      <h3>Add Repayment</h3>
      <div class="row">
        <input id="r_member" placeholder="Member ID (bigint)">
        <input id="r_amount" type="number" placeholder="Amount">
      </div>
      <button onclick="addRepayment()">Add Repayment</button>

      <h3>Run System</h3>
      <div class="row">
        <button class="secondary" onclick="runPayout()">Run Payout</button>
        <button class="secondary" onclick="runAllRules()">Run All Njangi Rules</button>
      </div>
    </div>

    <!-- TABLES -->
    <div id="tab_tables" class="card hide">
      <h2>Tables (Read Only)</h2>
      <div class="muted">These tables show only what your RLS policies allow.</div>

      <div style="margin:10px 0" class="row">
        <button class="secondary" onclick="refreshTables()">Refresh Tables</button>
        <button class="danger" onclick="clearTables()">Clear View</button>
      </div>

      <div class="tableGrid">
        <div class="tbox">
          <div class="tboxHead"><strong>Members</strong><span class="muted" id="count_members">--</span></div>
          <div class="tboxBody" id="tbl_members"></div>
        </div>

        <div class="tbox">
          <div class="tboxHead"><strong>Contributions</strong><span class="muted" id="count_contrib">--</span></div>
          <div class="tboxBody" id="tbl_contrib"></div>
        </div>

        <div class="tbox">
          <div class="tboxHead"><strong>Fines</strong><span class="muted" id="count_fines">--</span></div>
          <div class="tboxBody" id="tbl_fines"></div>
        </div>

        <div class="tbox">
          <div class="tboxHead"><strong>Loans</strong><span class="muted" id="count_loans">--</span></div>
          <div class="tboxBody" id="tbl_loans"></div>
        </div>

        <div class="tbox">
          <div class="tboxHead"><strong>Foundation Payments</strong><span class="muted" id="count_found">--</span></div>
          <div class="tboxBody" id="tbl_found"></div>
        </div>

        <div class="tbox">
          <div class="tboxHead"><strong>Repayments</strong><span class="muted" id="count_repays">--</span></div>
          <div class="tboxBody" id="tbl_repays"></div>
        </div>
      </div>
    </div>

  </div>

<script>
  // =============================
  // CONFIG
  // =============================
  const SUPABASE_URL = "https://ficlrtvrrzfiakmciwel.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpY2xydHZycnpmaWFrbWNpd2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjk0MDQsImV4cCI6MjA4MjcwNTQwNH0.xWuH_-amYd_24R8PURbZXMUDjz--Q9R_RASOdGzsZJI"; // <-- keep your real key here
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let sessionUser = null;
  let isAdmin = false;

  // =============================
  // UI HELPERS
  // =============================
  function setStatus(ok, text){
    statusDot.classList.toggle("ok", !!ok);
    statusText.textContent = text;
  }
  function show(id, yes=true){
    document.getElementById(id).classList.toggle("hide", !yes);
  }
  function switchTab(name){
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelector(`.tab[data-tab="${name}"]`)?.classList.add("active");
    ["overview","member","admin","tables"].forEach(t => show("tab_"+t, t===name));
  }
  async function callRPC(name, payload={}){
    const { data, error } = await sb.rpc(name, payload);
    if(error){ throw error; }
    return data;
  }

  function fmtMoney(v){
    if(v === null || v === undefined || v === "") return "--";
    const n = Number(v);
    if(Number.isNaN(n)) return String(v);
    return n.toLocaleString(undefined, { maximumFractionDigits: 2 });
  }

  function fmtDateISO(d){
    if(!d) return "--";
    const dt = new Date(d);
    if(Number.isNaN(dt.getTime())) return String(d);
    return dt.toISOString().slice(0,10);
  }

  function addDays(dateObj, days){
    const d = new Date(dateObj);
    d.setDate(d.getDate() + days);
    return d;
  }

  // =============================
  // AUTH
  // =============================
  async function login(){
    loginStatus.textContent = "";
    const { data, error } = await sb.auth.signInWithPassword({
      email: email.value.trim(),
      password: password.value
    });

    if(error){
      loginStatus.textContent = error.message;
      setStatus(false, "Login failed");
      return;
    }

    sessionUser = data.user;
    setStatus(true, "Logged in: " + sessionUser.email);

    show("appTabs", true);
    switchTab("overview");

    await detectAdmin();
    await loadOverview();
    await refreshTables();
  }

  async function logout(){
    await sb.auth.signOut();
    sessionUser = null;
    isAdmin = false;
    setStatus(false, "Not logged in");
    show("appTabs", false);
    ["overview","member","admin","tables"].forEach(t => show("tab_"+t, false));
    loginStatus.textContent = "Logged out";
  }

  async function detectAdmin(){
    try{
      const v = await callRPC("is_admin");
      isAdmin = (v === true) || (v === "true") || (v?.is_admin === true);
    }catch(e){
      isAdmin = false;
    }
    myRole.textContent = isAdmin ? "admin" : "member";
    adminTabBtn.style.display = isAdmin ? "inline-flex" : "none";
    if(!isAdmin) show("tab_admin", false);
  }

  // =============================
  // OVERVIEW (read-only KPIs)
  // =============================
  async function loadOverview(){
    try{
      // 1) Pot + member id + my value from your RPCs
      let pot = null, myId = null, myVal = null;
      

      try{ pot = await callRPC("current_pot_amount"); }catch(e){}
      try{ myId = await callRPC("current_member_id"); }catch(e){}
      try{
        if(myId !== null && myId !== undefined){
          myVal = await callRPC("member_total_value", { p_member_id: Number(myId) });
          const totalF = await callRPC("current_cycle_foundation");
totalFoundationPayment.textContent = fmtMoney(totalF);

        }
      }catch(e){}

      potAmount.textContent = fmtMoney(pot);
      myMemberId.textContent = (myId ?? "--");
      myValue.textContent = fmtMoney(myVal);

      if(myId && !loan_borrower.value) loan_borrower.value = myId;

      // 2) Pending Foundation Payments (sum of amount_pending where status='pending')
      //    Use RPC if you have it; otherwise compute from table
      let pendingTotal = null;
      try{
        pendingTotal = await callRPC("total_pending_foundation_amount");
      }catch(e){
        const q = await sb
          .from("foundation_payments")
          .select("amount_pending,status")
          .limit(1000); // if you have many rows, we can switch to RPC later

        if(!q.error && q.data){
          pendingTotal = q.data
            .filter(r => String(r.status || "").toLowerCase() === "pending")
            .reduce((s,r) => s + Number(r.amount_pending || 0), 0);
        }
      }
      pendingFoundation.textContent = fmtMoney(pendingTotal);

      // 3) Total Loans + Total Interest (use RPCs if present, else fallback)
      let loansTotal = null;
      try{
        loansTotal = await callRPC("total_loans_amount");
      }catch(e){
        const q = await sb.from("loans").select("*").limit(1000);
        if(!q.error && q.data){
          // Try common columns: principal, amount, total_amount, balance
          loansTotal = q.data.reduce((s,r) => {
            const v = r.total_amount ?? r.principal ?? r.amount ?? r.balance ?? 0;
            return s + Number(v || 0);
          }, 0);
        }
      }
      totalLoans.textContent = fmtMoney(loansTotal);

      let interestTotal = null;
      try{
        interestTotal = await callRPC("total_interest_generated");
      }catch(e){
        // Fallback: if you track interest in a table, add it here later.
        // We'll try to sum loans.interest_total / interest_generated if it exists.
        const q = await sb.from("loans").select("*").limit(1000);
        if(!q.error && q.data){
          interestTotal = q.data.reduce((s,r) => {
            const v = r.total_interest ?? r.interest_total ?? r.interest_generated ?? r.interest ?? 0;
            return s + Number(v || 0);
          }, 0);
        }
      }
      totalInterest.textContent = fmtMoney(interestTotal);

      // 4) Beneficiary date (bi-weekly)
      //    Best: RPC last_beneficiary_date. Fallback: read payouts table.
      let lastBen = null;
      try{
        lastBen = await callRPC("last_beneficiary_date");
      }catch(e){
        const q = await sb.from("payouts").select("*").order("created_at", {ascending:false}).limit(1);
        if(!q.error && q.data && q.data[0]){
          lastBen = q.data[0].payout_date ?? q.data[0].created_at ?? null;
        }
      }

      if(lastBen){
        const lastDate = new Date(lastBen);
        const nextDate = addDays(lastDate, 14); // bi-weekly = 14 days
        beneficiaryDate.textContent = `${fmtDateISO(lastDate)} → ${fmtDateISO(nextDate)}`;
      }else{
        beneficiaryDate.textContent = "--";
      }

    }catch(e){
      // keep UI alive
    }
  }

  // =============================
  // ADMIN INSERTS
  // =============================
  async function addMember(){
    if(!isAdmin){ alert("Admin only"); return; }
    const payload = { name: m_name.value.trim(), email: m_email.value.trim(), phone: m_phone.value.trim() };
    const { error } = await sb.from("members").insert([payload]);
    if(error){ alert(error.message); return; }
    alert("Member added");
    await refreshTables();
  }

  async function addContribution(){
    if(!isAdmin){ alert("Admin only"); return; }
    await callRPC("add_contribution", {
      p_member_id: Number(c_member.value),
      p_amount: Number(c_amount.value)
    });
    alert("Contribution added");
    await loadOverview();
    await refreshTables();
  }

  async function addFine(){
    if(!isAdmin){ alert("Admin only"); return; }
    await callRPC("add_fine", {
      p_member_id: Number(f_member.value),
      p_amount: Number(f_amount.value),
      p_reason: (f_reason.value || "").trim()
    });
    alert("Fine added");
    await loadOverview();
    await refreshTables();
  }

  // ✅ NEW: Insert pending foundation payment directly into foundation_payments table
  async function addFoundationPending(){
    if(!isAdmin){ alert("Admin only"); return; }

    const memberId = Number(fp_member.value);
    const paid = Number(fp_paid.value || 0);
    const pending = Number(fp_pending.value || 0);
    const status = (fp_status.value || "pending").trim().toLowerCase();

    if(!memberId || Number.isNaN(memberId)){ alert("Enter Member ID"); return; }
    if(Number.isNaN(paid) || paid < 0){ alert("Paid amount invalid"); return; }
    if(Number.isNaN(pending) || pending < 0){ alert("Pending amount invalid"); return; }
    if(paid === 0 && pending === 0){ alert("Enter paid or pending amount"); return; }

    // Your table shown: amount_paid, amount_pending, status (and member_id)
    const row = {
      member_id: memberId,
      amount_paid: paid,
      amount_pending: pending,
      status: status
    };

    const { error } = await sb.from("foundation_payments").insert([row]);
    if(error){
      alert("Insert failed (RLS or columns mismatch): " + error.message);
      return;
    }

    alert("Foundation payment added (" + status + ")");
    await loadOverview();
    await refreshTables();
  }

  async function addRepayment(){
    if(!isAdmin){ alert("Admin only"); return; }
    const memberId = Number(r_member.value);
    const amount = Number(r_amount.value);
    const { error } = await sb.from("repayments").insert([{
      member_id: memberId,
      amount: amount
    }]);
    if(error){
      alert("Repayment insert failed (RLS or missing columns). Error: " + error.message);
      return;
    }
    alert("Repayment added");
    await loadOverview();
    await refreshTables();
  }

  async function runPayout(){
    if(!isAdmin){ alert("Admin only"); return; }
    await callRPC("run_payout");
    alert("Payout executed");
    await loadOverview();
    await refreshTables();
  }

  async function runAllRules(){
    if(!isAdmin){ alert("Admin only"); return; }
    await callRPC("run_all_njangi_rules");
    alert("Rules executed");
    await loadOverview();
    await refreshTables();
  }

  // =============================
  // MEMBER ACTIONS
  // =============================
  async function requestLoan(){
    await callRPC("borrow_eligibility", {
      p_borrower_id: Number(loan_borrower.value),
      p_surety_id: Number(loan_surety.value),
      p_amount: Number(loan_amount.value)
    });
    alert("Loan request sent (eligibility checked by Supabase)");
    await loadOverview();
    await refreshTables();
  }

  async function payInterest(){
    const loanId = (pi_loan_id.value || "").trim();
    const amount = Number(pi_amount.value);
    if(!loanId){ alert("Enter Loan ID"); return; }
    await callRPC("pay_interest", { p_loan_id: loanId, p_amount: amount });
    alert("Interest paid");
    await loadOverview();
    await refreshTables();
  }

  // =============================
  // TABLE RENDER
  // =============================
  function renderTable(el, rows){
    if(!rows || rows.length === 0){
      el.innerHTML = `<div class="muted">No rows (or blocked by RLS)</div>`;
      return 0;
    }
    const cols = Object.keys(rows[0]);
    const head = cols.map(c => `<th>${c}</th>`).join("");
    const body = rows.map(r => `<tr>${cols.map(c => `<td>${r[c] ?? ""}</td>`).join("")}</tr>`).join("");
    el.innerHTML = `<table><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table>`;
    return rows.length;
  }

  async function refreshTables(){
    const q1 = await sb.from("members").select("*").order("id", { ascending: false }).limit(60);
    const q2 = await sb.from("contributions").select("*").order("id", { ascending: false }).limit(60);
    const q3 = await sb.from("fines").select("*").order("id", { ascending: false }).limit(60);
    const q4 = await sb.from("loans").select("*").order("id", { ascending: false }).limit(60);
    const q5 = await sb.from("foundation_payments").select("*").order("id", { ascending: false }).limit(60);
    const q6 = await sb.from("repayments").select("*").order("id", { ascending: false }).limit(60);

    count_members.textContent = q1.data ? `${q1.data.length} rows` : "—";
    count_contrib.textContent = q2.data ? `${q2.data.length} rows` : "—";
    count_fines.textContent = q3.data ? `${q3.data.length} rows` : "—";
    count_loans.textContent = q4.data ? `${q4.data.length} rows` : "—";
    count_found.textContent = q5.data ? `${q5.data.length} rows` : "—";
    count_repays.textContent = q6.data ? `${q6.data.length} rows` : "—";

    renderTable(tbl_members, q1.data || []);
    renderTable(tbl_contrib, q2.data || []);
    renderTable(tbl_fines, q3.data || []);
    renderTable(tbl_loans, q4.data || []);
    renderTable(tbl_found, q5.data || []);
    renderTable(tbl_repays, q6.data || []);
  }

  function clearTables(){
    ["tbl_members","tbl_contrib","tbl_fines","tbl_loans","tbl_found","tbl_repays"].forEach(id=>{
      document.getElementById(id).innerHTML = `<div class="muted">Cleared</div>`;
    });
  }
</script>

</body>
</html>
