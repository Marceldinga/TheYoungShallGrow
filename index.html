<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TheYoungShallGrow Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --primary:#1f4b99;
      --primary2:#2a6adf;
      --accent:#14b8a6;
      --danger:#ef4444;
      --warning:#f59e0b;
      --success:#22c55e;

      --bg:#0b1220;
      --bg2:#111827;
      --card:#151c2f;
      --card2:#1b2440;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#253056;

      --shadow: 0 14px 40px rgba(15, 23, 42, .35);
      --shadow2: 0 8px 20px rgba(15, 23, 42, .25);
      --radius:18px;
      --ring: 0 0 0 4px rgba(42,106,223,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 15% 0%, rgba(42,106,223,.18), transparent 55%),
        radial-gradient(900px 600px at 85% 15%, rgba(20,184,166,.12), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      min-height:100vh;
    }

    #locked{
      display:flex;align-items:center;justify-content:center;
      min-height:100vh;padding:22px;
    }
    .lockBox{
      width:min(520px,100%);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      padding:18px;
      box-shadow:var(--shadow);
    }
    .lockTop{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;margin-bottom:10px;
    }
    .brandMini{
      display:flex;align-items:center;gap:10px;
      font-weight:900; letter-spacing:.2px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:linear-gradient(135deg, var(--primary2), var(--accent));
      box-shadow:0 0 18px rgba(42,106,223,.25);
    }
    .authTabs{display:flex;gap:10px;margin:10px 0 10px}
    .authTabs button{flex:1}
    .authHint{
      font-size:12px;color:var(--muted);
      padding:10px 12px;
      background:rgba(42,106,223,.10);
      border:1px dashed rgba(42,106,223,.25);
      border-radius:14px;
      margin-bottom:10px;
    }

    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card2);
      color:var(--text);
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    input::placeholder{color:#94a3b8}
    input:focus{
      border-color: rgba(42,106,223,.45);
      box-shadow: var(--ring);
      background:var(--card2);
    }

    .btn{
      padding:11px 14px;
      border-radius:14px;
      border:1px solid rgba(31,75,153,.35);
      background: linear-gradient(135deg, rgba(42,106,223,.20), rgba(20,184,166,.12));
      color:var(--text);
      cursor:pointer;
      box-shadow:var(--shadow2);
      transition: transform .08s ease, filter .10s ease, box-shadow .12s ease;
      font-weight:700;
    }
    .btn:hover{filter:brightness(1.03)}
    .btn:active{transform: translateY(1px)}
    .btn.ghost{
      background:var(--card2);
      box-shadow:none;
      border-color: var(--border);
      font-weight:700;
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(31,75,153,.98), rgba(42,106,223,.95));
      color:#fff;
      border-color: rgba(31,75,153,.30);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed;filter:grayscale(20%);box-shadow:none}

    .lockGrid{display:grid;grid-template-columns:1fr;gap:10px}
    .err{
      color:#fecaca;
      background:rgba(239,68,68,.10);
      border:1px solid rgba(239,68,68,.25);
      padding:10px 12px;border-radius:14px;
      white-space:pre-wrap;font-size:12px;
      display:none;
    }

    .wrap{display:flex;min-height:100vh}
    .sidebar{
      width:330px;
      padding:16px;
      border-right:1px solid var(--border);
      background:rgba(21,28,47,.92);
      backdrop-filter: blur(10px);
    }
    .main{flex:1;padding:18px}

    .brand{
      font-weight:900;
      font-size:16px;
      letter-spacing:.2px;
      display:flex;align-items:center;gap:10px;
    }
    .sub{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.4}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      margin-top:14px;
      box-shadow:var(--shadow2);
    }
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(31,75,153,.10);
      font-size:12px;
      color:var(--text);
      white-space:nowrap;
    }
    .pill b{font-weight:900}

    #toast{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
      background:rgba(15,23,42,.92);
      color:#fff;
      padding:10px 14px;
      border-radius:14px;
      box-shadow:var(--shadow);
      display:none;
      z-index:9999;
      max-width:min(560px,92vw);
      font-size:13px;
    }
  </style>
</head>

<body>

<!-- LOGIN / SIGNUP -->
<div id="locked">
  <div class="lockBox">
    <div class="lockTop">
      <div class="brandMini"><span class="dot"></span> TheYoungShallGrow</div>
      <span class="pill">Secure Login</span>
    </div>

    <div class="sub">Sign in to manage Njangi contributions, loans, and payouts.</div>

    <div class="authTabs">
      <button id="tabSignIn" class="btn primary" type="button">Sign in</button>
      <button id="tabSignUp" class="btn ghost" type="button">Sign up</button>
    </div>

    <div class="lockGrid">
      <div id="signupFields" style="display:none;">
        <div class="authHint">
          ✅ Sign up is allowed ONLY if your email is already registered by Admin in <b>members.email</b>.
          <br>After sign up, your login is <b>pending</b> until admin approves.
        </div>
      </div>

      <input id="email" placeholder="Email" autocomplete="username" />
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" />

      <button id="btnAuth" class="btn primary" type="button">Sign in</button>
      <div id="lockErr" class="err"></div>
    </div>
  </div>
</div>

<!-- APP (simple placeholder so login completes) -->
<div id="app" class="wrap" style="display:none;">
  <aside class="sidebar">
    <div class="brand"><span class="dot"></span> TheYoungShallGrow: Dashboard</div>
    <div class="sub">Today • <span id="today"></span></div>

    <div class="card">
      <div class="row"><span class="sub">Signed in</span><span class="pill" id="who">—</span></div>
      <div class="row" style="margin-top:10px;"><span class="sub">Role</span><span class="pill" id="role">—</span></div>
      <button class="btn ghost" style="width:100%;margin-top:10px" type="button" id="btnLogout">Logout</button>
      <div id="sideErr" class="err"></div>
    </div>
  </aside>

  <main class="main">
    <div class="card">
      <div style="font-weight:900">✅ Login Success</div>
      <div class="sub" style="margin-top:8px">
        If you see this screen, authentication + profiles gate is working.
        Next step is loading your tables (members, contributions, loans, etc.).
      </div>
    </div>
  </main>
</div>

<div id="toast"></div>

<script>
/* =========================================================
   SUPABASE CONFIG (YOUR PROJECT)
========================================================= */
const SUPABASE_URL = "https://ficlrtvrrzfiakmciwel.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpY2xydHZycnpmaWFrbWNpd2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjk0MDQsImV4cCI6MjA4MjcwNTQwNH0.xWuH_-amYd_24R8PURbZXMUDjz--Q9R_RASOdGzsZJI";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
});

let AUTH_MODE = "signin";

/* ===========================
   UI HELPERS
=========================== */
function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = String(msg || "");
  el.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(() => { el.style.display = "none"; }, 3500);
}
function lockErr(msg){
  const el = document.getElementById("lockErr");
  el.style.display = msg ? "block" : "none";
  el.textContent = msg || "";
}
function sideErr(msg){
  const el = document.getElementById("sideErr");
  if(!el) return;
  el.style.display = msg ? "block" : "none";
  el.textContent = msg || "";
}
function setAuthLoading(on){
  const btn = document.getElementById("btnAuth");
  btn.disabled = !!on;
  btn.textContent = on ? "Please wait..." : (AUTH_MODE === "signup" ? "Create account" : "Sign in");
}
function applyAuthModeUI(){
  const su = document.getElementById("signupFields");
  const btn = document.getElementById("btnAuth");
  const tabIn = document.getElementById("tabSignIn");
  const tabUp = document.getElementById("tabSignUp");

  if(AUTH_MODE === "signup"){
    su.style.display = "block";
    btn.textContent = "Create account";
    tabUp.classList.remove("ghost"); tabUp.classList.add("primary");
    tabIn.classList.add("ghost"); tabIn.classList.remove("primary");
  } else {
    su.style.display = "none";
    btn.textContent = "Sign in";
    tabIn.classList.remove("ghost"); tabIn.classList.add("primary");
    tabUp.classList.add("ghost"); tabUp.classList.remove("primary");
  }
}
function setAuthMode(mode){
  AUTH_MODE = (mode === "signup") ? "signup" : "signin";
  lockErr(""); sideErr("");
  applyAuthModeUI();
}

/* ===========================
   HARD TIMEOUT (prevents infinite "Please wait...")
=========================== */
function withTimeout(promise, ms, label){
  return Promise.race([
    promise,
    new Promise((_, reject) => setTimeout(() => reject(new Error(`${label} timed out after ${ms/1000}s`)), ms))
  ]);
}

/* ===========================
   LOGIN GATE: profiles
=========================== */
async function enforceAdminGate(){
  const { data: userRes, error: userErr } = await sb.auth.getUser();
  if(userErr) throw userErr;

  const user = userRes?.user;
  if(!user) return false;

  const { data: profile, error } = await sb
    .from("profiles")
    .select("role, approved, member_id")
    .eq("id", user.id)
    .maybeSingle();

  if(error) throw error;
  if(!profile) throw new Error("No profiles row for this user.");

  // Require approved for members, admins always pass
  const isAdmin = (profile.role === "admin");
  const approved = !!profile.approved;

  if(!isAdmin && !approved){
    await sb.auth.signOut();
    lockErr("Your account is pending admin approval. Please wait for admin to approve.");
    return false;
  }

  document.getElementById("locked").style.display = "none";
  document.getElementById("app").style.display = "flex";

  document.getElementById("who").textContent = user.email || "";
  document.getElementById("role").textContent = profile.role || "member";
  document.getElementById("today").textContent = new Date().toLocaleDateString();

  return true;
}

/* ===========================
   AUTH
=========================== */
async function signIn(){
  lockErr(""); sideErr("");
  const email = document.getElementById("email").value.trim().toLowerCase();
  const password = document.getElementById("password").value;

  if(!email || !password){
    lockErr("Enter email and password.");
    return;
  }

  setAuthLoading(true);

  try{
    // If your request is blocked by network/adblock, this is where it hangs.
    const res = await withTimeout(
      sb.auth.signInWithPassword({ email, password }),
      15000,
      "Sign in"
    );

    if(res.error) throw res.error;

    const ok = await withTimeout(enforceAdminGate(), 15000, "Profile check");
    if(!ok) return;

    toast("Welcome");
  }catch(e){
    console.error("SIGNIN ERROR:", e);
    lockErr(
      (e?.message || String(e)) +
      "\n\nIf this keeps timing out, your browser/network is blocking requests to Supabase."
    );
  }finally{
    setAuthLoading(false);
  }
}

async function signUp(){
  lockErr(""); sideErr("");
  const email = document.getElementById("email").value.trim().toLowerCase();
  const password = document.getElementById("password").value;

  if(!email || !password){
    lockErr("Enter email and password.");
    return;
  }

  setAuthLoading(true);

  try{
    // Only allow signup if email exists in members
    const pre = await withTimeout(
      sb.from("members").select("id,email").eq("email", email).maybeSingle(),
      15000,
      "Members lookup"
    );

    if(pre.error) throw pre.error;
    if(!pre.data) throw new Error("Signup blocked: your email is not registered by admin yet.");

    const s = await withTimeout(
      sb.auth.signUp({ email, password }),
      15000,
      "Sign up"
    );

    if(s.error) throw s.error;

    toast("Account created. Waiting for admin approval.");
    await sb.auth.signOut();
    setAuthMode("signin");
    lockErr("Your account is pending admin approval. Please wait.");
  }catch(e){
    console.error("SIGNUP ERROR:", e);
    lockErr(e?.message || String(e));
  }finally{
    setAuthLoading(false);
  }
}

async function signOut(){
  await sb.auth.signOut();
  sideErr(""); lockErr("");
  document.getElementById("app").style.display = "none";
  document.getElementById("locked").style.display = "flex";
}

/* ===========================
   INIT / WIRE UI
=========================== */
document.addEventListener("DOMContentLoaded", async () => {
  document.getElementById("tabSignIn").addEventListener("click", ()=>setAuthMode("signin"));
  document.getElementById("tabSignUp").addEventListener("click", ()=>setAuthMode("signup"));
  document.getElementById("btnAuth").addEventListener("click", ()=> AUTH_MODE === "signup" ? signUp() : signIn());
  document.getElementById("btnLogout").addEventListener("click", signOut);

  document.getElementById("password").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") (AUTH_MODE === "signup" ? signUp() : signIn());
  });

  setAuthMode("signin");

  // If already signed in, go straight in
  try{
    const ok = await enforceAdminGate();
    if(ok) toast("Session restored");
  }catch(e){
    console.warn("Auto gate check:", e?.message || e);
  }
});
</script>

</body>
</html>
