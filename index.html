<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>The Young Shall Grow – Njangi Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b1220; --panel:#111827; --card:#151c2f; --card2:#1b2440;
      --text:#e5e7eb; --muted:#9ca3af; --border:#253056;
      --green:#22c55e; --blue:#2a6adf; --danger:#ef4444;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:14px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(42,106,223,.35), transparent 60%),
                  radial-gradient(1000px 500px at 80% -20%, rgba(34,197,94,.25), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    .wrap{ max-width:1200px; margin:0 auto; padding:22px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:16px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand h1{ margin:0; font-size:20px; letter-spacing:-.02em; }
    .brand p{ margin:0; color:var(--muted); font-size:13px; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid var(--border); border-radius:999px;
      background: rgba(17,24,39,.6);
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--danger); }
    .dot.ok{ background:var(--green); }

    .card{
      background: linear-gradient(180deg, rgba(27,36,64,.9), rgba(17,24,39,.7));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin-bottom:14px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .col-12{ grid-column: span 12; }
    .col-8{ grid-column: span 8; }
    .col-6{ grid-column: span 6; }
    .col-4{ grid-column: span 4; }
    .col-3{ grid-column: span 3; }

    @media (max-width: 980px){
      .col-8,.col-6,.col-4,.col-3{ grid-column: span 12; }
    }

    h2{ margin:0 0 10px; font-size:16px; color:var(--green); }
    h3{ margin:14px 0 8px; font-size:14px; color:#cfe7ff; font-weight:600; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:180px; }

    input, select{
      width:100%;
      padding:10px 11px;
      border-radius: 10px;
      border:1px solid var(--border);
      background: rgba(11,18,32,.65);
      color:var(--text);
      outline:none;
    }
    input::placeholder{ color:#7c879b; }

    button{
      width:100%;
      padding:10px 12px;
      border-radius: 10px;
      border:1px solid rgba(34,197,94,.35);
      background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(34,197,94,.75));
      color:#06210f;
      font-weight:700;
      cursor:pointer;
      transition: transform .08s ease, opacity .15s ease;
    }
    button:hover{ opacity:.92; }
    button:active{ transform: translateY(1px); }
    button.secondary{
      background: rgba(42,106,223,.18);
      border:1px solid rgba(42,106,223,.40);
      color:#dbeafe;
      font-weight:650;
    }
    button.danger{
      background: rgba(239,68,68,.18);
      border:1px solid rgba(239,68,68,.40);
      color:#fee2e2;
      font-weight:650;
    }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:8px; border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(17,24,39,.55);
      margin-bottom:14px;
    }
    .tab{
      padding:9px 12px;
      border-radius: 10px;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      font-weight:650;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(42,106,223,.45);
      background: rgba(42,106,223,.16);
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){ .kpis{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 520px){ .kpis{ grid-template-columns: 1fr; } }

    .kpi{
      border:1px solid var(--border);
      background: rgba(11,18,32,.55);
      border-radius: 14px;
      padding:12px;
    }
    .kpi .label{ color: var(--muted); font-size:12px; }
    .kpi .value{ margin-top:4px; font-size:18px; font-weight:800; letter-spacing:-.02em; }

    .muted{ color: var(--muted); font-size:13px; }

    /* Tables */
    .tableGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .tbox{
      grid-column: span 6;
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(11,18,32,.45);
      overflow:hidden;
      min-height: 260px;
      display:flex;
      flex-direction:column;
    }
    @media (max-width: 980px){ .tbox{ grid-column: span 12; } }

    .tboxHead{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(17,24,39,.55);
    }
    .tboxHead strong{ color:#dbeafe; font-size:13px; }
    .tboxBody{ overflow:auto; padding:10px 12px; max-height: 360px; }

    table{ width:100%; border-collapse:collapse; font-size:12px; }
    th, td{
      padding:8px 8px;
      border-bottom:1px solid rgba(37,48,86,.55);
      text-align:left;
      vertical-align:top;
      white-space:nowrap;
    }
    th{
      position:sticky; top:0;
      background: rgba(21,28,47,.95);
      color:#cfe7ff;
      z-index:1;
    }

    .hide{ display:none; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <h1>The Young Shall Grow – Njangi</h1>
        <p>Clean dashboard (Supabase handles all rules & totals)</p>
      </div>
      <div class="pill">
        <span id="statusDot" class="dot"></span>
        <span id="statusText" class="muted">Not logged in</span>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h2>Login</h2>
      <div class="grid">
        <div class="col-6"><input id="email" placeholder="Email"></div>
        <div class="col-6"><input id="password" type="password" placeholder="Password"></div>
        <div class="col-6"><button onclick="login()">Login</button></div>
        <div class="col-6"><button class="secondary" onclick="logout()">Logout</button></div>
        <div class="col-12"><div id="loginStatus" class="muted"></div></div>
      </div>
    </div>

    <!-- TABS -->
    <div id="appTabs" class="tabs hide">
      <button class="tab active" data-tab="overview" onclick="switchTab('overview')">Overview</button>
      <button class="tab" data-tab="member" onclick="switchTab('member')">Member</button>
      <button class="tab" data-tab="admin" id="adminTabBtn" onclick="switchTab('admin')">Admin</button>
      <button class="tab" data-tab="tables" onclick="switchTab('tables')">Tables</button>
    </div>

    <!-- OVERVIEW -->
    <div id="tab_overview" class="card hide">
      <h2>Overview</h2>
      <div class="kpis">
        <div class="kpi"><div class="label">Pot Amount</div><div class="value" id="potAmount">--</div></div>
        <div class="kpi"><div class="label">My Total Value</div><div class="value" id="myValue">--</div></div>
        <div class="kpi"><div class="label">My Member ID</div><div class="value" id="myMemberId">--</div></div>
        <div class="kpi"><div class="label">Role</div><div class="value" id="myRole">--</div></div>
      </div>
      <div style="margin-top:10px" class="muted">
        Tip: Click <b>Tables</b> to view all records your RLS allows. Admin can also insert using the Admin tab.
      </div>
    </div>

    <!-- MEMBER -->
    <div id="tab_member" class="card hide">
      <h2>Member Actions</h2>

      <h3>Request Loan</h3>
      <div class="row">
        <input id="loan_borrower" placeholder="Your Member ID (bigint)">
        <input id="loan_surety" placeholder="Surety Member ID (bigint)">
        <input id="loan_amount" type="number" placeholder="Amount">
      </div>
      <button onclick="requestLoan()">Request Loan</button>

      <h3 style="margin-top:16px;">Pay Interest (if you use it)</h3>
      <div class="row">
        <input id="pi_loan_id" placeholder="Loan ID (uuid)">
        <input id="pi_amount" type="number" placeholder="Amount">
      </div>
      <button class="secondary" onclick="payInterest()">Pay Interest</button>
    </div>

    <!-- ADMIN -->
    <div id="tab_admin" class="card hide">
      <h2>Admin Actions</h2>
      <div class="muted">Admin tab shows only if <b>is_admin()</b> returns true for your logged-in user.</div>

      <h3>Add Member</h3>
      <div class="row">
        <input id="m_name" placeholder="Name">
        <input id="m_email" placeholder="Email">
        <input id="m_phone" placeholder="Phone">
      </div>
      <button onclick="addMember()">Add Member</button>

      <h3>Add Contribution</h3>
      <div class="row">
        <input id="c_member" placeholder="Member ID (bigint)">
        <input id="c_amount" type="number" placeholder="Amount">
      </div>
      <button onclick="addContribution()">Add Contribution</button>

      <h3>Add Fine</h3>
      <div class="row">
        <input id="f_member" placeholder="Member ID (bigint)">
        <input id="f_amount" type="number" placeholder="Amount">
        <input id="f_reason" placeholder="Reason">
      </div>
      <button onclick="addFine()">Add Fine</button>

      <h3>Add Foundation Payment</h3>
      <div class="row">
        <input id="fp_member" placeholder="Member ID (bigint)">
        <input id="fp_amount" type="number" placeholder="Amount">
      </div>
      <button onclick="addFoundation()">Add Foundation Payment</button>

      <h3>Add Repayment</h3>
      <div class="row">
        <input id="r_member" placeholder="Member ID (bigint)">
        <input id="r_amount" type="number" placeholder="Amount">
      </div>
      <button onclick="addRepayment()">Add Repayment</button>

      <h3>Run System</h3>
      <div class="row">
        <button class="secondary" onclick="runPayout()">Run Payout</button>
        <button class="secondary" onclick="runAllRules()">Run All Njangi Rules</button>
      </div>
    </div>

    <!-- TABLES -->
    <div id="tab_tables" class="card hide">
      <h2>Tables (Read Only)</h2>
      <div class="muted">These tables show only what your RLS policies allow.</div>

      <div style="margin:10px 0" class="row">
        <button class="secondary" onclick="refreshTables()">Refresh Tables</button>
        <button class="danger" onclick="clearTables()">Clear View</button>
      </div>

      <div class="tableGrid">
        <div class="tbox">
          <div class="tboxHead"><strong>Members</strong><span class="muted" id="count_members">--</span></div>
          <div class="tboxBody" id="tbl_members"></div>
        </div>

        <div class="tbox">
          <div class="tboxHead"><strong>Contributions</strong><span class="muted" id="count_contrib">--</span></div>
          <div class="tboxBody" id="tbl_contrib"></div>
        </div>

        <div class="tbox">
          <div class="tboxHead"><strong>Fines</strong><span class="muted" id="count_fines">--</span></div>
          <div class="tboxBody" id="tbl_fines"></div>
        </div>

        <div class="tbox">
          <div class="tboxHead"><strong>Loans</strong><span class="muted" id="count_loans">--</span></div>
          <div class="tboxBody" id="tbl_loans"></div>
        </div>

        <div class="tbox">
          <div class="tboxHead"><strong>Foundation Payments</strong><span class="muted" id="count_found">--</span></div>
          <div class="tboxBody" id="tbl_found"></div>
        </div>

        <div class="tbox">
          <div class="tboxHead"><strong>Repayments</strong><span class="muted" id="count_repays">--</span></div>
          <div class="tboxBody" id="tbl_repays"></div>
        </div>
      </div>
    </div>

  </div>

<script>
  // =============================
  // CONFIG
  // =============================
  const SUPABASE_URL = "https://ficlrtvrrzfiakmciwel.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpY2xydHZycnpmaWFrbWNpd2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjk0MDQsImV4cCI6MjA4MjcwNTQwNH0.xWuH_-amYd_24R8PURbZXMUDjz--Q9R_RASOdGzsZJI";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let sessionUser = null;
  let isAdmin = false;

  // =============================
  // UI HELPERS
  // =============================
  function setStatus(ok, text){
    statusDot.classList.toggle("ok", !!ok);
    statusText.textContent = text;
  }

  function show(id, yes=true){
    document.getElementById(id).classList.toggle("hide", !yes);
  }

  function switchTab(name){
    // tabs
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelector(`.tab[data-tab="${name}"]`)?.classList.add("active");

    // sections
    ["overview","member","admin","tables"].forEach(t => show("tab_"+t, t===name));
  }

  async function callRPC(name, payload={}){
    const { data, error } = await sb.rpc(name, payload);
    if(error){ alert(error.message); throw error; }
    return data;
  }

  // =============================
  // AUTH
  // =============================
  async function login(){
    loginStatus.textContent = "";
    const { data, error } = await sb.auth.signInWithPassword({
      email: email.value.trim(),
      password: password.value
    });

    if(error){
      loginStatus.textContent = error.message;
      setStatus(false, "Login failed");
      return;
    }

    sessionUser = data.user;
    setStatus(true, "Logged in: " + sessionUser.email);

    // Show tabs + default view
    show("appTabs", true);
    switchTab("overview");

    // Determine admin role
    await detectAdmin();

    // Load stats + tables
    await loadOverview();
    await refreshTables();
  }

  async function logout(){
    await sb.auth.signOut();
    sessionUser = null;
    isAdmin = false;
    setStatus(false, "Not logged in");
    show("appTabs", false);
    ["overview","member","admin","tables"].forEach(t => show("tab_"+t, false));
    loginStatus.textContent = "Logged out";
  }

  async function detectAdmin(){
    // Uses your existing function: is_admin()
    try{
      const v = await callRPC("is_admin");
      isAdmin = (v === true) || (v === "true") || (v?.is_admin === true);
    }catch(e){
      isAdmin = false;
    }
    myRole.textContent = isAdmin ? "admin" : "member";
    adminTabBtn.style.display = isAdmin ? "inline-flex" : "none";
    // If not admin and user clicked admin, fallback
    if(!isAdmin){
      show("tab_admin", false);
    }
  }

  // =============================
  // OVERVIEW (read-only)
  // =============================
  async function loadOverview(){
  try{
    const pot = await callRPC("current_pot_amount");
    const myId = await callRPC("current_member_id");

    const myVal = await callRPC("member_total_value", {
      p_member_id: myId
    });

    potAmount.textContent = (pot ?? "--");
    myValue.textContent = (myVal ?? "--");
    myMemberId.textContent = (myId ?? "--");

    if(myId && !loan_borrower.value) loan_borrower.value = myId;
  }catch(e){
    // keep UI alive
  }
}


  // =============================
  // ADMIN INSERTS
  // =============================
  async function addMember(){
    if(!isAdmin){ alert("Admin only"); return; }
    const payload = { name: m_name.value.trim(), email: m_email.value.trim(), phone: m_phone.value.trim() };
    const { error } = await sb.from("members").insert([payload]);
    if(error){ alert(error.message); return; }
    alert("Member added");
    await refreshTables();
  }

  async function addContribution(){
    if(!isAdmin){ alert("Admin only"); return; }
    await callRPC("add_contribution", {
      p_member_id: BigInt(c_member.value),
      p_amount: Number(c_amount.value)
    });
    alert("Contribution added");
    await loadOverview();
    await refreshTables();
  }

  async function addFine(){
    if(!isAdmin){ alert("Admin only"); return; }
    await callRPC("add_fine", {
      p_member_id: BigInt(f_member.value),
      p_amount: Number(f_amount.value),
      p_reason: (f_reason.value || "").trim()
    });
    alert("Fine added");
    await loadOverview();
    await refreshTables();
  }

  async function addFoundation(){
    if(!isAdmin){ alert("Admin only"); return; }

    // IMPORTANT:
    // You do NOT have a function named "add_foundation_payment" in your list.
    // The only relevant function you showed is: repayments_update_foundation(p_member_id bigint)
    // So we call it, passing member_id only. If yours also needs amount, update the RPC signature accordingly.
    //
    // If you actually have a different function for foundation payments, replace the name here.
    try{
      await callRPC("repayments_update_foundation", {
        p_member_id: BigInt(fp_member.value)
      });
      alert("Foundation update executed");
    }catch(e){
      alert("Your function repayments_update_foundation may not accept amount. Check its arguments in Supabase.");
    }

    await loadOverview();
    await refreshTables();
  }

  async function addRepayment(){
    if(!isAdmin){ alert("Admin only"); return; }

    // You have: pay_interest(p_loan_id uuid, p_amount numeric)
    // For repayments, you did not show a dedicated add_repayment RPC.
    // If your repayment insert is direct table insert allowed by RLS, we can insert into repayments.
    // We'll try table insert first.
    const memberId = r_member.value.trim();
    const amount = Number(r_amount.value);

    // Try inserting to repayments table (if RLS allows admin insert)
    const { error } = await sb.from("repayments").insert([{
      member_id: memberId ? BigInt(memberId) : null,
      amount: amount
    }]);

    if(error){
      alert("Repayment insert failed (RLS or missing columns). Error: " + error.message);
      return;
    }

    alert("Repayment added");
    await loadOverview();
    await refreshTables();
  }

  async function runPayout(){
    if(!isAdmin){ alert("Admin only"); return; }
    await callRPC("run_payout");
    alert("Payout executed");
    await loadOverview();
    await refreshTables();
  }

  async function runAllRules(){
    if(!isAdmin){ alert("Admin only"); return; }
    await callRPC("run_all_njangi_rules");
    alert("Rules executed");
    await loadOverview();
    await refreshTables();
  }

  // =============================
  // MEMBER ACTIONS
  // =============================
  async function requestLoan(){
    await callRPC("borrow_eligibility", {
      p_borrower_id: BigInt(loan_borrower.value),
      p_surety_id: BigInt(loan_surety.value),
      p_amount: Number(loan_amount.value)
    });
    alert("Loan request sent (eligibility checked by Supabase)");
    await loadOverview();
    await refreshTables();
  }

  async function payInterest(){
    const loanId = (pi_loan_id.value || "").trim();
    const amount = Number(pi_amount.value);
    if(!loanId){ alert("Enter Loan ID"); return; }
    await callRPC("pay_interest", { p_loan_id: loanId, p_amount: amount });
    alert("Interest paid");
    await loadOverview();
    await refreshTables();
  }

  // =============================
  // TABLE RENDER
  // =============================
  function renderTable(el, rows){
    if(!rows || rows.length === 0){
      el.innerHTML = `<div class="muted">No rows (or blocked by RLS)</div>`;
      return 0;
    }
    const cols = Object.keys(rows[0]);
    const head = cols.map(c => `<th>${c}</th>`).join("");
    const body = rows.map(r => `<tr>${cols.map(c => `<td>${r[c] ?? ""}</td>`).join("")}</tr>`).join("");
    el.innerHTML = `<table><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table>`;
    return rows.length;
  }

  async function refreshTables(){
    // Fetch small slices so UI stays fast
    const q1 = await sb.from("members").select("*").order("id", { ascending: false }).limit(60);
    const q2 = await sb.from("contributions").select("*").order("id", { ascending: false }).limit(60);
    const q3 = await sb.from("fines").select("*").order("id", { ascending: false }).limit(60);
    const q4 = await sb.from("loans").select("*").order("id", { ascending: false }).limit(60);
    const q5 = await sb.from("foundation_payments").select("*").order("id", { ascending: false }).limit(60);
    const q6 = await sb.from("repayments").select("*").order("id", { ascending: false }).limit(60);

    count_members.textContent = q1.data ? `${q1.data.length} rows` : "—";
    count_contrib.textContent = q2.data ? `${q2.data.length} rows` : "—";
    count_fines.textContent = q3.data ? `${q3.data.length} rows` : "—";
    count_loans.textContent = q4.data ? `${q4.data.length} rows` : "—";
    count_found.textContent = q5.data ? `${q5.data.length} rows` : "—";
    count_repays.textContent = q6.data ? `${q6.data.length} rows` : "—";

    renderTable(tbl_members, q1.data || []);
    renderTable(tbl_contrib, q2.data || []);
    renderTable(tbl_fines, q3.data || []);
    renderTable(tbl_loans, q4.data || []);
    renderTable(tbl_found, q5.data || []);
    renderTable(tbl_repays, q6.data || []);
  }

  function clearTables(){
    ["tbl_members","tbl_contrib","tbl_fines","tbl_loans","tbl_found","tbl_repays"].forEach(id=>{
      document.getElementById(id).innerHTML = `<div class="muted">Cleared</div>`;
    });
  }
</script>

</body>
</html>
