<!DOCTYPE html>
<html>
<head>
  <title>The Young Shall Grow – Njangi Dashboard</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#151c2f; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#22c55e; --danger:#ef4444; --border:#253056;
    }
    body{ font-family: Arial, sans-serif; background:var(--bg); color:var(--text); padding:18px; }
    h1,h2,h3{ color:var(--accent); margin: 8px 0; }
    .grid{ display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .card{ background:var(--card); border:1px solid var(--border); padding:16px; border-radius:12px; }
    input, select, button, textarea{
      padding:10px; margin:6px 0; width:100%; box-sizing:border-box;
      background:#0f172a; color:var(--text); border:1px solid var(--border); border-radius:10px;
    }
    textarea{ min-height: 70px; resize: vertical; }
    button{ background:var(--accent); border:none; color:#08120b; cursor:pointer; font-weight:700; }
    button:hover{ opacity:0.9; }
    .btnRow{ display:flex; gap:10px; }
    .btnRow > button{ width:100%; }
    .muted{ color:var(--muted); font-size: 0.92rem; }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); }
    .hide{ display:none !important; }
    table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:0.92rem; }
    th, td{ border-bottom:1px solid var(--border); padding:8px; text-align:left; vertical-align: top; }
    th{ color: var(--muted); font-weight:700; }
    .ok{ color: var(--accent); }
    .err{ color: var(--danger); }
    canvas{ width:100% !important; height:260px !important; }
    .small{ font-size: 0.9rem; }
    .topbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  </style>
</head>

<body>

<h1>The Young Shall Grow – Njangi Dashboard</h1>
<div class="topbar">
  <span class="pill">Single-file HTML</span>
  <span class="pill" id="rolePill">Role: --</span>
  <span class="pill" id="memberPill">Member ID: --</span>
</div>

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h2>Login</h2>
  <input id="email" placeholder="Email" autocomplete="username">
  <input id="password" type="password" placeholder="Password" autocomplete="current-password">
  <div class="btnRow">
    <button onclick="login()">Login</button>
    <button onclick="logout()" style="background:#94a3b8;">Logout</button>
  </div>
  <p id="loginStatus" class="muted"></p>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hide">

  <!-- STATS -->
  <div class="grid">
    <div class="card">
      <h2>System Stats</h2>
      <p class="small">Pot Amount: <b id="potAmount">--</b></p>
      <p class="small">Your Total Value: <b id="myValue">--</b></p>
      <p class="muted" id="rlsNote">Tables and charts show what your RLS allows you to read.</p>
      <div class="btnRow">
        <button onclick="refreshAll()">Refresh</button>
        <button onclick="runRulesQuick()" style="background:#f59e0b;">Run Rules (Admin)</button>
      </div>
      <p id="statusMsg" class="muted"></p>
    </div>

    <div class="card">
      <h2>Charts</h2>
      <p class="muted">Contributions & Fines (best-effort, depends on RLS).</p>
      <canvas id="chartContrib"></canvas>
      <canvas id="chartFine" style="margin-top:14px;"></canvas>
    </div>
  </div>

  <!-- ADMIN ACTIONS -->
  <div class="card" id="adminCard">
    <h2>Admin Actions</h2>
    <p class="muted">This section is hidden for members. Admin is detected using <b>is_admin()</b>.</p>

    <div class="grid">
      <div>
        <h3>Add Member (table insert)</h3>
        <input id="m_name" placeholder="Name">
        <input id="m_email" placeholder="Email">
        <input id="m_phone" placeholder="Phone">
        <button onclick="addMember()">Add Member</button>
        <p class="muted">Note: This inserts into <b>members</b> table only. Creating auth user is separate (Supabase Auth signup/invite).</p>
      </div>

      <div>
        <h3>Add Contribution (RPC)</h3>
        <input id="c_member" placeholder="Member ID (bigint)">
        <input id="c_amount" type="number" placeholder="Amount">
        <button onclick="addContribution()">Add Contribution</button>

        <h3 style="margin-top:14px;">Add Fine (RPC)</h3>
        <input id="f_member" placeholder="Member ID (bigint)">
        <input id="f_amount" type="number" placeholder="Amount">
        <input id="f_reason" placeholder="Reason (text)">
        <button onclick="addFine()">Add Fine</button>
      </div>

      <div>
        <h3>Foundation / Repayment (RPC)</h3>
        <p class="muted">
          You only showed one RPC for these: <b>repayments_update_foundation</b>.
          This code calls it with best-effort payload.
        </p>
        <input id="fp_member" placeholder="Member ID (bigint)">
        <input id="fp_amount" type="number" placeholder="Amount">
        <div class="btnRow">
          <button onclick="addFoundation()">Add Foundation Payment</button>
          <button onclick="addRepayment()" style="background:#38bdf8;">Add Repayment</button>
        </div>

        <h3 style="margin-top:14px;">Pay Interest (RPC)</h3>
        <input id="pi_loan" placeholder="Loan ID (uuid)">
        <input id="pi_amount" type="number" placeholder="Amount">
        <button onclick="payInterest()">Pay Interest</button>
      </div>
    </div>

    <h3 style="margin-top:14px;">Run System (RPC)</h3>
    <div class="btnRow">
      <button onclick="runPayout()">Run Payout</button>
      <button onclick="runRotationPayout()" style="background:#a78bfa;">Run Rotation Payout</button>
      <button onclick="runAllRules()" style="background:#f59e0b;">Run All Njangi Rules</button>
    </div>
  </div>

  <!-- MEMBER LOAN REQUEST -->
  <div class="card">
    <h2>Member Loan Request</h2>
    <p class="muted">
      Your Member ID is auto-detected using <b>current_member_id()</b>. You only select surety + amount.
    </p>
    <input id="loan_surety" placeholder="Surety Member ID (bigint)">
    <input id="loan_amount" type="number" placeholder="Amount">
    <button onclick="requestLoan()">Request Loan</button>
    <p id="loanMsg" class="muted"></p>
  </div>

  <!-- TABLES -->
  <div class="card">
    <h2>Tables (Read Only)</h2>
    <p class="muted">These tables will show only what your RLS policies allow.</p>

    <div class="grid">
      <div>
        <h3>Members</h3>
        <div id="tbl_members"></div>
      </div>
      <div>
        <h3>Contributions</h3>
        <div id="tbl_contrib"></div>
      </div>
      <div>
        <h3>Fines</h3>
        <div id="tbl_fines"></div>
      </div>
      <div>
        <h3>Loans</h3>
        <div id="tbl_loans"></div>
      </div>
      <div>
        <h3>Foundation Payments</h3>
        <div id="tbl_foundation"></div>
      </div>
      <div>
        <h3>Repayments</h3>
        <div id="tbl_repayments"></div>
      </div>
    </div>
  </div>

</div>

<script>
/* =========================
   CONFIG
========================= */
const SUPABASE_URL = "https://ficlrtvrrzfiakmciwel.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpY2xydHZycnpmaWFrbWNpd2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjk0MDQsImV4cCI6MjA4MjcwNTQwNH0.xWuH_-amYd_24R8PURbZXMUDjz--Q9R_RASOdGzsZJI";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let IS_ADMIN = false;
let MY_MEMBER_ID = null;

let chartContrib = null;
let chartFine = null;

/* =========================
   SMALL HELPERS
========================= */
function setStatus(msg, ok=true){
  const el = document.getElementById("statusMsg");
  el.innerText = msg || "";
  el.className = ok ? "muted ok" : "muted err";
}

function renderTable(containerId, rows){
  const el = document.getElementById(containerId);
  if(!rows || rows.length === 0){
    el.innerHTML = `<p class="muted">No rows (or blocked by RLS).</p>`;
    return;
  }
  const cols = Object.keys(rows[0]).slice(0, 8); // keep it simple
  let html = `<table><thead><tr>${cols.map(c=>`<th>${c}</th>`).join("")}</tr></thead><tbody>`;
  for(const r of rows.slice(0, 15)){
    html += `<tr>${cols.map(c=>`<td>${escapeHtml(String(r[c] ?? ""))}</td>`).join("")}</tr>`;
  }
  html += `</tbody></table>`;
  el.innerHTML = html;
}

function escapeHtml(s){
  return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

async function callRPC(name, payload={}){
  const { data, error } = await sb.rpc(name, payload);
  if(error){
    console.error("RPC error:", name, error);
    throw new Error(error.message || "RPC failed");
  }
  return data;
}

/* Try multiple payload shapes (because your borrow_eligibility args are partially hidden) */
async function callRPCWithFallback(name, payloadOptions){
  let lastErr = null;
  for(const payload of payloadOptions){
    try{
      const data = await callRPC(name, payload);
      return { ok:true, data, used: payload };
    }catch(e){
      lastErr = e;
    }
  }
  return { ok:false, error:lastErr };
}

/* =========================
   AUTH
========================= */
async function login(){
  setStatus("");
  const { data, error } = await sb.auth.signInWithPassword({
    email: document.getElementById("email").value,
    password: document.getElementById("password").value
  });

  const loginStatus = document.getElementById("loginStatus");

  if(error){
    loginStatus.innerText = error.message;
    loginStatus.className = "muted err";
    return;
  }

  loginStatus.innerText = "Login successful";
  loginStatus.className = "muted ok";
  document.getElementById("dashboard").classList.remove("hide");

  await initUserContext();
  await refreshAll();
}

async function logout(){
  await sb.auth.signOut();
  document.getElementById("dashboard").classList.add("hide");
  document.getElementById("loginStatus").innerText = "Logged out";
  document.getElementById("rolePill").innerText = "Role: --";
  document.getElementById("memberPill").innerText = "Member ID: --";
  IS_ADMIN = false;
  MY_MEMBER_ID = null;
}

async function initUserContext(){
  // is_admin()
  try{
    const admin = await callRPC("is_admin");
    IS_ADMIN = !!admin;
  }catch(e){
    IS_ADMIN = false;
  }

  // current_member_id()
  try{
    const mid = await callRPC("current_member_id");
    MY_MEMBER_ID = (mid === null || mid === undefined) ? null : mid;
  }catch(e){
    MY_MEMBER_ID = null;
  }

  document.getElementById("rolePill").innerText = `Role: ${IS_ADMIN ? "admin" : "member"}`;
  document.getElementById("memberPill").innerText = `Member ID: ${MY_MEMBER_ID ?? "--"}`;

  // Hide admin section for members
  const adminCard = document.getElementById("adminCard");
  if(!IS_ADMIN) adminCard.classList.add("hide");
  else adminCard.classList.remove("hide");
}

/* =========================
   LOAD STATS
========================= */
async function loadStats(){
  // pot
  try{
    const pot = await callRPC("current_pot_amount");
    document.getElementById("potAmount").innerText = pot ?? "--";
  }catch(e){
    document.getElementById("potAmount").innerText = "--";
  }

  // member_total_value(p_member_id bigint)
  try{
    if(MY_MEMBER_ID == null) throw new Error("No member id");
    const val = await callRPC("member_total_value", { p_member_id: Number(MY_MEMBER_ID) });
    document.getElementById("myValue").innerText = val ?? "--";
  }catch(e){
    document.getElementById("myValue").innerText = "--";
  }
}

/* =========================
   TABLE + CHART DATA LOAD
========================= */
async function refreshAll(){
  setStatus("Refreshing…");
  await loadStats();

  // Members table (admin might see all; members might see only themselves)
  await loadTable("members", "tbl_members");

  // Other tables (best effort)
  await loadTable("contributions", "tbl_contrib", { orderBy: "created_at", desc: true });
  await loadTable("fines", "tbl_fines", { orderBy: "created_at", desc: true });
  await loadTable("loans", "tbl_loans", { orderBy: "created_at", desc: true });
  await loadTable("foundation_payments", "tbl_foundation", { orderBy: "created_at", desc: true });
  await loadTable("repayments", "tbl_repayments", { orderBy: "created_at", desc: true });

  // Charts based on contributions + fines rows
  const contribRows = await fetchRows("contributions", { orderBy: "created_at", desc: false, limit: 300 });
  const fineRows = await fetchRows("fines", { orderBy: "created_at", desc: false, limit: 300 });
  renderCharts(contribRows, fineRows);

  setStatus("Done ✅", true);
}

async function fetchRows(table, opts={}){
  let q = sb.from(table).select("*").limit(opts.limit ?? 50);
  if(opts.orderBy){
    q = q.order(opts.orderBy, { ascending: !(opts.desc) });
  }
  const { data, error } = await q;
  if(error){
    console.warn("Fetch blocked or error:", table, error.message);
    return [];
  }
  return data || [];
}

async function loadTable(table, containerId, opts={}){
  const rows = await fetchRows(table, { ...opts, limit: 30 });
  renderTable(containerId, rows);
}

function groupByDayAmount(rows, amountField){
  // returns labels[] and values[] for last ~14 days if present
  const map = new Map();
  for(const r of (rows || [])){
    const d = r.created_at ? new Date(r.created_at) : null;
    if(!d || isNaN(d)) continue;
    const key = d.toISOString().slice(0,10);
    const amt = Number(r[amountField] ?? 0);
    map.set(key, (map.get(key) || 0) + amt);
  }
  const labels = Array.from(map.keys()).sort();
  const values = labels.map(k => map.get(k));
  return { labels, values };
}

function renderCharts(contribRows, fineRows){
  // Contribution chart
  const c = groupByDayAmount(contribRows, "amount");
  const f = groupByDayAmount(fineRows, "amount");

  const ctxC = document.getElementById("chartContrib");
  const ctxF = document.getElementById("chartFine");

  if(chartContrib) chartContrib.destroy();
  if(chartFine) chartFine.destroy();

  chartContrib = new Chart(ctxC, {
    type: "line",
    data: { labels: c.labels, datasets: [{ label: "Contributions (daily sum)", data: c.values }] },
    options: { responsive:true, maintainAspectRatio:false }
  });

  chartFine = new Chart(ctxF, {
    type: "bar",
    data: { labels: f.labels, datasets: [{ label: "Fines (daily sum)", data: f.values }] },
    options: { responsive:true, maintainAspectRatio:false }
  });
}

/* =========================
   ADMIN ACTIONS
========================= */
async function addMember(){
  if(!IS_ADMIN) return alert("Admin only");
  try{
    const payload = {
      name: document.getElementById("m_name").value.trim(),
      email: document.getElementById("m_email").value.trim(),
      phone: document.getElementById("m_phone").value.trim()
    };
    const { error } = await sb.from("members").insert([payload]);
    if(error) throw new Error(error.message);
    alert("Member added ✅");
    await refreshAll();
  }catch(e){
    alert("Add member failed: " + e.message);
  }
}

async function addContribution(){
  if(!IS_ADMIN) return alert("Admin only");
  try{
    await callRPC("add_contribution", {
      p_member_id: Number(document.getElementById("c_member").value),
      p_amount: Number(document.getElementById("c_amount").value)
    });
    alert("Contribution added ✅");
    await refreshAll();
  }catch(e){
    alert("Add contribution failed: " + e.message);
  }
}

async function addFine(){
  if(!IS_ADMIN) return alert("Admin only");
  try{
    await callRPC("add_fine", {
      p_member_id: Number(document.getElementById("f_member").value),
      p_amount: Number(document.getElementById("f_amount").value),
      p_reason: String(document.getElementById("f_reason").value || "")
    });
    alert("Fine added ✅");
    await refreshAll();
  }catch(e){
    alert("Add fine failed: " + e.message);
  }
}

/*
  repayments_update_foundation args were not fully visible in your screenshot.
  We will call it with fallbacks:
  - {p_member_id, p_amount}
  - {p_member_id, p_payment_amount}
  - {p_member_id, p_value}
  - {p_member_id}  (if your function calculates amount internally)
*/
async function addFoundation(){
  if(!IS_ADMIN) return alert("Admin only");
  const mid = Number(document.getElementById("fp_member").value);
  const amt = Number(document.getElementById("fp_amount").value);

  const res = await callRPCWithFallback("repayments_update_foundation", [
    { p_member_id: mid, p_amount: amt },
    { p_member_id: mid, p_payment_amount: amt },
    { p_member_id: mid, p_value: amt },
    { p_member_id: mid }
  ]);

  if(!res.ok){
    alert("Foundation update failed: " + res.error.message);
    return;
  }
  alert("Foundation payment applied ✅");
  await refreshAll();
}

async function addRepayment(){
  if(!IS_ADMIN) return alert("Admin only");
  // Using same function because it's the only one you showed.
  // If you later create add_repayment() we will swap it in.
  return addFoundation();
}

async function payInterest(){
  if(!IS_ADMIN) return alert("Admin only");
  try{
    await callRPC("pay_interest", {
      p_loan_id: document.getElementById("pi_loan").value.trim(),
      p_amount: Number(document.getElementById("pi_amount").value)
    });
    alert("Interest payment recorded ✅");
    await refreshAll();
  }catch(e){
    alert("Pay interest failed: " + e.message);
  }
}

async function runPayout(){
  if(!IS_ADMIN) return alert("Admin only");
  try{
    await callRPC("run_payout");
    alert("run_payout ✅");
    await refreshAll();
  }catch(e){
    alert("run_payout failed: " + e.message);
  }
}

async function runRotationPayout(){
  if(!IS_ADMIN) return alert("Admin only");
  try{
    await callRPC("run_rotation_payout");
    alert("run_rotation_payout ✅");
    await refreshAll();
  }catch(e){
    alert("run_rotation_payout failed: " + e.message);
  }
}

async function runAllRules(){
  if(!IS_ADMIN) return alert("Admin only");
  try{
    await callRPC("run_all_njangi_rules");
    alert("run_all_njangi_rules ✅");
    await refreshAll();
  }catch(e){
    alert("run_all_njangi_rules failed: " + e.message);
  }
}

async function runRulesQuick(){
  if(!IS_ADMIN) return alert("Admin only");
  return runAllRules();
}

/* =========================
   MEMBER: LOAN REQUEST
========================= */
async function requestLoan(){
  const msg = document.getElementById("loanMsg");
  msg.innerText = "";

  if(MY_MEMBER_ID == null){
    msg.innerText = "No member_id found for this account. Make sure your members table maps to auth email correctly.";
    msg.className = "muted err";
    return;
  }

  const surety = Number(document.getElementById("loan_surety").value);
  const amount = Number(document.getElementById("loan_amount").value);

  // Your borrow_eligibility args were cut off in the screenshot.
  // We'll try common parameter names until one works.
  const res = await callRPCWithFallback("borrow_eligibility", [
    { p_borrower_id: Number(MY_MEMBER_ID), p_surety_id: surety, p_amount: amount },
    { p_borrower_id: Number(MY_MEMBER_ID), p_surety_id: surety, p_requested_amount: amount },
    { p_borrower_id: Number(MY_MEMBER_ID), p_surety_id: surety, p_request_amount: amount },
    { p_borrower_id: Number(MY_MEMBER_ID), p_surety_id: surety, p_requested: amount }
  ]);

  if(!res.ok){
    msg.innerText = "Loan request failed: " + res.error.message;
    msg.className = "muted err";
    return;
  }

  msg.innerText = "Loan request submitted ✅ (borrow_eligibility ran).";
  msg.className = "muted ok";
  await refreshAll();
}

/* Auto-resume if already logged in */
(async function boot(){
  const { data } = await sb.auth.getSession();
  if(data?.session){
    document.getElementById("dashboard").classList.remove("hide");
    await initUserContext();
    await refreshAll();
    document.getElementById("loginStatus").innerText = "Session restored ✅";
    document.getElementById("loginStatus").className = "muted ok";
  }
})();
</script>

</body>
</html>
