<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TheYoungShallGrow Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --primary:#1f4b99; --primary2:#2a6adf; --accent:#14b8a6;
      --danger:#ef4444; --warning:#f59e0b; --success:#22c55e;
      --bg:#0b1220; --bg2:#111827; --card:#151c2f; --card2:#1b2440;
      --text:#e5e7eb; --muted:#9ca3af; --border:#253056;
      --shadow: 0 14px 40px rgba(15, 23, 42, .35);
      --shadow2: 0 8px 20px rgba(15, 23, 42, .25);
      --radius:18px; --ring: 0 0 0 4px rgba(42,106,223,.18);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 15% 0%, rgba(42,106,223,.18), transparent 55%),
        radial-gradient(900px 600px at 85% 15%, rgba(20,184,166,.12), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      min-height:100vh;
    }

    #locked{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:22px;}
    .lockBox{width:min(520px,100%);background:var(--card);border:1px solid var(--border);border-radius:22px;padding:18px;box-shadow:var(--shadow);}
    .lockTop{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;}
    .brandMini{display:flex;align-items:center;gap:10px;font-weight:900;}
    .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,var(--primary2),var(--accent));box-shadow:0 0 18px rgba(42,106,223,.25);}
    .sub{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.4}
    .authTabs{display:flex;gap:10px;margin:10px 0 10px}
    .authTabs button{flex:1}

    input,select,textarea{
      width:100%;padding:12px 12px;border-radius:14px;border:1px solid var(--border);
      background:var(--card2);color:var(--text);outline:none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    input:focus,select:focus,textarea:focus{border-color: rgba(42,106,223,.45);box-shadow: var(--ring);}
    textarea{min-height:96px;resize:vertical}

    .btn{
      padding:11px 14px;border-radius:14px;border:1px solid rgba(31,75,153,.35);
      background: linear-gradient(135deg, rgba(42,106,223,.20), rgba(20,184,166,.12));
      color:var(--text);cursor:pointer;box-shadow:var(--shadow2);font-weight:700;
      transition: transform .06s ease, filter .10s ease;
    }
    .btn:hover{filter:brightness(1.03)}
    .btn:active{transform: translateY(1px)}
    .btn.ghost{background:var(--card2);box-shadow:none;border-color:var(--border);}
    .btn.primary{background: linear-gradient(135deg, rgba(31,75,153,.98), rgba(42,106,223,.95));color:#fff;border-color: rgba(31,75,153,.30);}
    .btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}

    .err{
      color:#fecaca;background:rgba(239,68,68,.10);border:1px solid rgba(239,68,68,.25);
      padding:10px 12px;border-radius:14px;white-space:pre-wrap;font-size:12px;display:none;
    }

    .wrap{display:flex;min-height:100vh}
    .sidebar{
      width:330px;padding:16px;border-right:1px solid var(--border);
      background:rgba(21,28,47,.92);backdrop-filter: blur(10px);
    }
    .main{flex:1;padding:18px}

    .brand{font-weight:900;font-size:16px;display:flex;align-items:center;gap:10px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-top:14px;box-shadow:var(--shadow2);}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(31,75,153,.10);font-size:12px;white-space:nowrap;}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:14px}
    .nav button{
      width:100%;text-align:left;padding:11px 12px;border-radius:14px;border:1px solid var(--border);
      background:var(--card2);color:var(--text);cursor:pointer;font-weight:800;
    }
    .nav button.active{border-color: rgba(42,106,223,.55);background: rgba(42,106,223,.14);}

    .section{display:none}
    .section.active{display:block}

    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    .tableWrap{overflow:auto;border-radius:14px;border:1px solid var(--border);margin-top:10px}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:760px;background:var(--card)}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:12px;}
    th{color:var(--muted);font-weight:900;background:#1f2937;position:sticky; top:0; z-index:1;}
    tbody tr:nth-child(even) td{background:#19213a}
    .tdMoney{text-align:right;font-variant-numeric: tabular-nums;}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;font-size:11px;font-weight:900;border:1px solid transparent;}
    .b-pending{color:#f59e0b;background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.25)}
    .b-active{color:#60a5fa;background:rgba(59,130,246,.12);border-color:rgba(59,130,246,.25)}
    .b-paid{color:#34d399;background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.25)}
    .b-unknown{color:#cbd5e1;background:rgba(148,163,184,.14);border-color:rgba(148,163,184,.22)}

    .miniBox{
      margin-top:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--card2);
    }
    .bigName{font-weight:1000;font-size:18px;margin-top:6px}
    .smallRow{display:flex;justify-content:space-between;gap:10px;margin-top:8px}
    .smallRow span{color:var(--muted);font-size:12px}
    .smallRow b{color:var(--text)}

    #toast{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
      background:rgba(15,23,42,.92);color:#fff;padding:10px 14px;border-radius:14px;
      box-shadow:var(--shadow);display:none;z-index:9999;max-width:min(560px,92vw);font-size:13px;
    }

    @media (max-width:1100px){ .grid4{grid-template-columns:1fr 1fr} .grid2{grid-template-columns:1fr} }
    @media (max-width:740px){ .wrap{flex-direction:column} .sidebar{width:100%;border-right:none;border-bottom:1px solid var(--border)} table{min-width:680px} }
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="locked">
  <div class="lockBox">
    <div class="lockTop">
      <div class="brandMini"><span class="dot"></span> TheYoungShallGrow</div>
      <span class="pill">Secure Login</span>
    </div>
    <div class="sub">Admin can add data. Members can view + request loans.</div>

    <div class="authTabs">
      <button id="tabSignIn" class="btn primary" type="button">Sign in</button>
      <button id="tabSignUp" class="btn ghost" type="button">Sign up</button>
    </div>

    <div id="signupHint" class="sub" style="display:none;margin-bottom:10px;">
      ✅ Signup only works if your email is already in <b>members.email</b>. After signup, admin must approve.
    </div>

    <div style="display:grid;gap:10px;">
      <input id="email" placeholder="Email" autocomplete="username" />
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="btnAuth" class="btn primary" type="button">Sign in</button>
      <div id="lockErr" class="err"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="wrap" style="display:none;">
  <aside class="sidebar">
    <div class="brand"><span class="dot"></span> TheYoungShallGrow: Dashboard</div>
    <div class="sub">Today • <span id="today"></span></div>

    <div class="card">
      <div class="row"><span class="sub">Signed in</span><span class="pill" id="who">—</span></div>
      <div class="row" style="margin-top:10px;"><span class="sub">Role</span><span class="pill" id="role">—</span></div>
      <button class="btn ghost" style="width:100%;margin-top:10px" type="button" id="btnLogout">Logout</button>
      <div id="sideErr" class="err"></div>
    </div>

    <div class="nav">
      <button class="active" type="button" data-sec="dash">Dashboard</button>
      <button type="button" data-sec="members" data-admin="1">Members</button>
      <button type="button" data-sec="contrib" data-admin="1">Contributions</button>
      <button type="button" data-sec="loans">Loans</button>
      <button type="button" data-sec="payouts" data-admin="1">Payouts</button>
      <button class="btn ghost" style="margin-top:6px" type="button" id="btnRefresh">Refresh</button>
    </div>

    <!-- ✅ ROTATION CARD -->
    <div class="card">
      <div class="row">
        <div style="font-weight:900">Rotation Payout</div>
        <span class="pill" id="rotRolePill">—</span>
      </div>

      <div class="miniBox">
        <div class="sub">Current Beneficiary (Next)</div>
        <div class="bigName" id="nextBeneficiary">—</div>

        <div class="smallRow">
          <span>Position</span>
          <b id="nextPosition">—</b>
        </div>

        <div class="smallRow">
          <span>Next payout date</span>
          <b id="nextPayoutDate">—</b>
        </div>

        <div class="smallRow">
          <span>Expected payout</span>
          <b id="expectedPayout">$0</b>
        </div>
      </div>

      <button class="btn primary" style="width:100%;margin-top:10px" type="button" id="btnRunPayout">
        Run Payout Now
      </button>
      <div class="sub" style="margin-top:10px">
        Uses <b>members.position</b> ordering + <b>app_state.next_payout_index</b>.
      </div>
    </div>

    <div class="card">
      <div class="sub"><b>Foundation Pot</b> (app_state.foundation)</div>
      <div style="margin-top:8px;font-weight:1000;font-size:18px" id="foundationPot">$0</div>
      <div class="sub" style="margin-top:10px">This is a column in <b>app_state</b> (not a separate “foundation” table).</div>
    </div>
  </aside>

  <main class="main">
    <div class="row" style="margin-bottom:14px;">
      <div>
        <div style="font-size:18px;font-weight:900" id="pageTitle">Dashboard</div>
        <div class="sub" id="pageHint">Overview + histogram</div>
      </div>
      <span class="pill">Total Interest: <b id="kInterestMini">$0</b></span>
    </div>

    <!-- DASH -->
    <section id="dash" class="section active">
      <div class="grid4">
        <div class="card">
          <div class="sub">Njangi Pot</div>
          <div style="font-size:22px;font-weight:1000" id="kPot">$0</div>
          <div class="sub">Sum of contributions</div>
        </div>
        <div class="card">
          <div class="sub">Foundation</div>
          <div style="font-size:22px;font-weight:1000" id="kFoundation">$0</div>
          <div class="sub">Available for loans</div>
        </div>
        <div class="card">
          <div class="sub">Outstanding Loans</div>
          <div style="font-size:22px;font-weight:1000" id="kLoans">$0</div>
          <div class="sub">Total due</div>
        </div>
        <div class="card">
          <div class="sub">Members</div>
          <div style="font-size:22px;font-weight:1000" id="kMembers">0</div>
          <div class="sub">Rotation list</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="row">
          <div style="font-weight:900">Histogram: Contributions (All Members)</div>
          <span class="pill">Live</span>
        </div>
        <div style="height:220px;margin-top:10px;">
          <canvas id="histChart"></canvas>
        </div>
      </div>
    </section>

    <!-- MEMBERS -->
    <section id="members" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:900">Add Member (Admin registers email)</div>
          <div class="sub">Members can only sign up if their email exists here first.</div>
          <div style="display:grid;gap:10px;margin-top:10px;">
            <input id="mName" placeholder="Name" />
            <input id="mEmail" placeholder="Email" />
            <input id="mPhone" placeholder="Phone (optional)" />
            <select id="mBenefits">
              <option value="false">Has benefits? No</option>
              <option value="true">Has benefits? Yes</option>
            </select>
            <button class="btn primary" type="button" id="btnAddMember">Add Member</button>
          </div>

          <div style="margin-top:14px;font-weight:900">Approve Pending Logins</div>
          <div class="tableWrap">
            <table>
              <thead><tr><th>Member</th><th>Approved</th><th>Action</th></tr></thead>
              <tbody id="approveBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="row"><div style="font-weight:900">Member List (sorted by position)</div><span class="pill" id="memberCountPill">0</span></div>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Pos</th><th>Name</th><th>Email</th>
                  <th class="tdMoney">Contrib</th>
                  <th class="tdMoney">Foundation</th>
                  <th class="tdMoney">Loan Due</th>
                  <th class="tdMoney">Payout Total</th>
                </tr>
              </thead>
              <tbody id="memberBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- CONTRIBUTIONS -->
    <section id="contrib" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:900">Add Contribution</div>
          <div style="display:grid;gap:10px;margin-top:10px;">
            <select id="cMember"></select>
            <input id="cAmount" type="number" placeholder="Amount (multiple of 500)" />
            <button class="btn primary" type="button" id="btnAddContrib">Save Contribution</button>
          </div>
          <div class="sub" style="margin-top:10px;">Rule: amount must be multiple of 500.</div>
        </div>
        <div class="card">
          <div style="font-weight:900">Tip</div>
          <div class="sub">Contributions feed the histogram and Njangi pot KPI.</div>
        </div>
      </div>
    </section>

    <!-- LOANS -->
    <section id="loans" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:900" id="loanFormTitle">Request Loan</div>
          <div class="sub" id="loanFormHint">Members request → pending until admin approves.</div>

          <div style="display:grid;gap:10px;margin-top:10px;">
            <label class="sub">Borrower</label>
            <select id="lBorrower"></select>

            <label class="sub">Surety</label>
            <select id="lSurety"></select>

            <label class="sub">Requested Amount</label>
            <input id="lAmount" type="number" placeholder="e.g. 2000" />

            <button class="btn primary" type="button" id="btnLoanAction">Request Loan</button>
          </div>

          <div class="sub" style="margin-top:10px">
            Status flow: <b>pending</b> → admin approves → <b>active</b>.
          </div>
        </div>

        <div class="card">
          <div class="row"><div style="font-weight:900">Loans</div><span class="pill">Latest</span></div>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Date</th><th>Borrower</th><th>Surety</th>
                  <th class="tdMoney">Principal</th>
                  <th class="tdMoney">Interest</th>
                  <th class="tdMoney">Total Due</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="loanBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- PAYOUTS -->
    <section id="payouts" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:900">Run Payout (Admin)</div>
          <div class="sub">Also updates member payout_total + app_state next index/date.</div>
          <button class="btn primary" type="button" id="btnRunPayout2" style="width:100%;margin-top:10px;">
            Run Payout Now
          </button>
        </div>
        <div class="card">
          <div class="row"><div style="font-weight:900">Payout History</div><span class="pill">Latest</span></div>
          <div class="tableWrap">
            <table>
              <thead><tr><th>Date</th><th>Member</th><th class="tdMoney">Amount</th></tr></thead>
              <tbody id="payoutBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<div id="toast"></div>

<script>
/* =========================
   SUPABASE CONFIG
========================= */
const SUPABASE_URL = "https://ficlrtvrrzfiakmciwel.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpY2xydHZycnpmaWFrbWNpd2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjk0MDQsImV4cCI6MjA4MjcwNTQwNH0.xWuH_-amYd_24R8PURbZXMUDjz--Q9R_RASOdGzsZJI"; // <-- paste your real anon key
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
});

/* =========================
   CONSTANTS
========================= */
const INTEREST_RATE = 0.05;
const FOUNDATION_FACTOR = 0.70;

/* =========================
   STATE
========================= */
let AUTH_MODE = "signin";
let isAdmin = false;
let currentMemberId = null;

let appState = null;
let members = [];
let contributions = [];
let loans = [];
let payouts = [];
let profiles = [];
let histChart = null;

/* =========================
   HELPERS
========================= */
const $ = (id) => document.getElementById(id);

function toast(msg){
  const el = $("toast");
  el.textContent = String(msg||"");
  el.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> el.style.display="none", 2800);
}
function lockErr(msg){
  const el = $("lockErr");
  el.style.display = msg ? "block":"none";
  el.textContent = msg||"";
}
function sideErr(msg){
  const el = $("sideErr");
  el.style.display = msg ? "block":"none";
  el.textContent = msg||"";
}
function money(x){ return "$" + (Number(x||0)).toLocaleString(); }
function badge(status){
  const s = String(status||"").toLowerCase();
  if(s==="pending") return `<span class="badge b-pending">Pending</span>`;
  if(s==="active") return `<span class="badge b-active">Active</span>`;
  if(s==="paid"||s==="paid_off") return `<span class="badge b-paid">Paid</span>`;
  return `<span class="badge b-unknown">${status||"—"}</span>`;
}
function showSection(sec, title, hint){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  $(sec).classList.add("active");
  $("pageTitle").textContent = title;
  $("pageHint").textContent = hint;

  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  const btn = document.querySelector(`.nav button[data-sec="${sec}"]`);
  if(btn) btn.classList.add("active");
}

/* =========================
   AUTH MODE
========================= */
function setAuthMode(mode){
  AUTH_MODE = (mode==="signup") ? "signup" : "signin";
  $("signupHint").style.display = (AUTH_MODE==="signup") ? "block":"none";
  $("btnAuth").textContent = (AUTH_MODE==="signup") ? "Create account" : "Sign in";
  $("tabSignIn").className = (AUTH_MODE==="signin") ? "btn primary" : "btn ghost";
  $("tabSignUp").className = (AUTH_MODE==="signup") ? "btn primary" : "btn ghost";
  lockErr("");
}

/* =========================
   GATE (profiles)
========================= */
async function enforceGate(){
  const { data, error } = await sb.auth.getUser();
  if(error) throw error;
  const user = data?.user;
  if(!user) return false;

  const pr = await sb
    .from("profiles")
    .select("role, approved, member_id")
    .eq("id", user.id)
    .maybeSingle();

  if(pr.error) throw pr.error;
  if(!pr.data) throw new Error("No profiles row for this user.");

  isAdmin = (pr.data.role === "admin");
  currentMemberId = pr.data.member_id ?? null;

  if(!isAdmin && !pr.data.approved){
    await sb.auth.signOut();
    lockErr("Your account is pending admin approval.");
    return false;
  }

  $("locked").style.display = "none";
  $("app").style.display = "flex";
  $("who").textContent = user.email || "";
  $("role").textContent = pr.data.role || "member";
  $("today").textContent = new Date().toLocaleDateString();

  // admin-only nav
  document.querySelectorAll("[data-admin='1']").forEach(b=>{
    b.style.display = isAdmin ? "block" : "none";
  });

  $("rotRolePill").textContent = isAdmin ? "Admin" : "Member";

  // payout buttons disabled for members
  $("btnRunPayout").disabled = !isAdmin;
  $("btnRunPayout2").disabled = !isAdmin;

  // interest mini pill visible only admin
  $("kInterestMini").parentElement.style.display = isAdmin ? "inline-flex" : "none";

  // loan label
  if(isAdmin){
    $("loanFormTitle").textContent = "Approve / Manage Loans (Admin)";
    $("loanFormHint").textContent = "Members request loans (pending). Admin approves → active.";
    $("btnLoanAction").textContent = "Create ACTIVE Loan";
  } else {
    $("loanFormTitle").textContent = "Request Loan (Member)";
    $("loanFormHint").textContent = "Your request will be pending until admin approves.";
    $("btnLoanAction").textContent = "Request Loan";
  }

  return true;
}

/* =========================
   SIGN IN / SIGN UP / OUT
========================= */
async function signIn(){
  lockErr(""); sideErr("");
  const email = $("email").value.trim().toLowerCase();
  const password = $("password").value;
  if(!email || !password) return lockErr("Enter email and password.");

  const { error } = await sb.auth.signInWithPassword({ email, password });
  if(error) return lockErr(error.message);

  const ok = await enforceGate();
  if(!ok) return;

  await reloadAll();
  toast("Welcome");
}

async function signUp(){
  lockErr(""); sideErr("");
  const email = $("email").value.trim().toLowerCase();
  const password = $("password").value;
  if(!email || !password) return lockErr("Enter email and password.");

  // allow signup only if email exists in members
  const pre = await sb.from("members").select("id,email").eq("email", email).maybeSingle();
  if(pre.error) return lockErr(pre.error.message);
  if(!pre.data) return lockErr("Signup blocked: your email is not registered by admin yet.");

  const s = await sb.auth.signUp({ email, password });
  if(s.error) return lockErr(s.error.message);

  toast("Account created. Waiting for admin approval.");
  await sb.auth.signOut();
  setAuthMode("signin");
  lockErr("Pending approval. Admin must approve you in profiles.");
}

async function signOut(){
  await sb.auth.signOut();
  $("app").style.display = "none";
  $("locked").style.display = "flex";
  sideErr(""); lockErr("");
}

/* =========================
   LOAD ALL (with contributions fallback)
========================= */
async function loadContributions(){
  // Try with kind filter (if your table has kind)
  let c = await sb.from("contributions").select("member_id, amount").eq("kind","contribution").limit(5000);
  if(!c.error) return c.data || [];

  // Fallback: table may not have "kind"
  c = await sb.from("contributions").select("member_id, amount").limit(5000);
  if(c.error) throw c.error;
  return c.data || [];
}

async function reloadAll(){
  sideErr("");

  const a = await sb.from("app_state").select("*").eq("id", 1).maybeSingle();
  if(a.error) return sideErr("app_state: " + a.error.message);
  appState = a.data || { foundation:0, total_interest_generated:0, next_payout_index:0, next_payout_date:null };

  const m = await sb.from("members").select("*").order("position", { ascending:true });
  if(m.error) return sideErr("members: " + m.error.message);
  members = m.data || [];

  try{
    contributions = await loadContributions();
  }catch(e){
    return sideErr("contributions: " + (e?.message || String(e)));
  }

  const l = await sb.from("loans").select("*").order("created_at", { ascending:false }).limit(300);
  if(l.error) return sideErr("loans: " + l.error.message);
  loans = l.data || [];

  const p = await sb.from("payouts").select("*").order("created_at", { ascending:false }).limit(200);
  if(p.error) return sideErr("payouts: " + p.error.message);
  payouts = p.data || [];

  if(isAdmin){
    const pr = await sb.from("profiles").select("id, role, approved, member_id");
    if(pr.error) return sideErr("profiles: " + pr.error.message);
    profiles = pr.data || [];
  } else {
    profiles = [];
  }

  renderAll();
}

/* =========================
   ELIGIBILITY
========================= */
function memberTotal(memberId){
  const m = members.find(x=>String(x.id)===String(memberId));
  if(!m) return 0;
  const cSum = contributions
    .filter(r=>String(r.member_id)===String(memberId))
    .reduce((s,r)=>s+Number(r.amount||0),0);
  const f = Number(m.foundation_contrib||0);
  return cSum + (f * FOUNDATION_FACTOR);
}
function eligible(borrowerId, suretyId, amt){
  const a = Number(amt||0);
  if(a<=0) return {ok:false, reason:"Invalid amount"};
  const bTot = memberTotal(borrowerId);
  if(bTot >= a) return {ok:true, reason:"Eligible (self)"};
  const sTot = memberTotal(suretyId);
  if((bTot + sTot) >= a) return {ok:true, reason:"Eligible (with surety)"};
  return {ok:false, reason:"Not eligible"};
}

/* =========================
   RENDER (includes rotation card)
========================= */
function renderAll(){
  // totals
  const totalsByMember = {};
  for(const r of contributions){
    const k = String(r.member_id);
    totalsByMember[k] = (totalsByMember[k]||0) + Number(r.amount||0);
  }
  const potSum = Object.values(totalsByMember).reduce((s,v)=>s+v,0);
  const outstanding = (members||[]).reduce((s,m)=>s+Number(m.loan_due||0),0);

  $("kPot").textContent = money(potSum);
  $("kFoundation").textContent = money(appState.foundation||0);
  $("foundationPot").textContent = money(appState.foundation||0);
  $("kLoans").textContent = money(outstanding);
  $("kMembers").textContent = String(members.length);
  $("memberCountPill").textContent = String(members.length);
  $("kInterestMini").textContent = money(appState.total_interest_generated||0);

  // ✅ rotation info
  $("expectedPayout").textContent = money(potSum);
  const idx = Number(appState.next_payout_index || 0);
  const nextIndex = members.length ? (idx % members.length) : 0;
  const next = members.length ? members[nextIndex] : null;
  $("nextBeneficiary").textContent = next ? (next.name || "—") : "—";
  $("nextPosition").textContent = next ? String(next.position ?? (nextIndex+1)) : "—";
  $("nextPayoutDate").textContent = appState.next_payout_date ? String(appState.next_payout_date) : "—";

  // member table (sorted by position)
  $("memberBody").innerHTML = (members||[]).map(m=>`
    <tr>
      <td>${m.position ?? ""}</td>
      <td>${m.name||""}</td>
      <td>${m.email||""}</td>
      <td class="tdMoney">${money(totalsByMember[String(m.id)]||0)}</td>
      <td class="tdMoney">${money(m.foundation_contrib||0)}</td>
      <td class="tdMoney">${money(m.loan_due||0)}</td>
      <td class="tdMoney">${money(m.payout_total||0)}</td>
    </tr>
  `).join("") || `<tr><td colspan="7" class="sub">No members</td></tr>`;

  // dropdowns
  const optsAll = (members||[]).map(m=>`<option value="${m.id}">${m.name}</option>`).join("");
  $("cMember").innerHTML = optsAll;
  $("lBorrower").innerHTML = optsAll;
  $("lSurety").innerHTML = optsAll;

  // member locks borrower
  if(!isAdmin && currentMemberId != null){
    $("lBorrower").value = String(currentMemberId);
    $("lBorrower").disabled = true;
  } else {
    $("lBorrower").disabled = false;
  }

  // approvals (admin)
  if(isAdmin){
    const pending = profiles.filter(p=>p.role==="member" && !p.approved && p.member_id != null);
    const byId = Object.fromEntries(members.map(m=>[String(m.id), m]));
    $("approveBody").innerHTML = pending.map(p=>{
      const mem = byId[String(p.member_id)];
      return `<tr>
        <td>${mem?.name || ("member_id="+p.member_id)}</td>
        <td>${badge(p.approved ? "paid":"pending")}</td>
        <td><button class="btn ghost" type="button" onclick="approveProfile('${p.id}')">Approve</button></td>
      </tr>`;
    }).join("") || `<tr><td colspan="3" class="sub">No pending approvals</td></tr>`;
  } else {
    $("approveBody").innerHTML = `<tr><td colspan="3" class="sub">Admin only</td></tr>`;
  }

  // loans
  $("loanBody").innerHTML = (loans||[]).map(r=>{
    const canApprove = isAdmin && String(r.status||"").toLowerCase()==="pending";
    const action = canApprove
      ? `<button class="btn ghost" type="button" onclick="approveLoan(${r.id})">Approve</button>`
      : "-";
    return `<tr>
      <td>${r.created_at ? new Date(r.created_at).toLocaleString() : ""}</td>
      <td>${r.borrower_name||""}</td>
      <td>${r.surety_name||""}</td>
      <td class="tdMoney">${money(r.principal||0)}</td>
      <td class="tdMoney">${money(r.interest||0)}</td>
      <td class="tdMoney">${money(r.total_due||0)}</td>
      <td>${badge(r.status||"")}</td>
      <td>${action}</td>
    </tr>`;
  }).join("") || `<tr><td colspan="8" class="sub">No loans</td></tr>`;

  // payouts
  $("payoutBody").innerHTML = (payouts||[]).map(x=>`
    <tr>
      <td>${x.payout_date||""}</td>
      <td>${x.member_name||""}</td>
      <td class="tdMoney">${money(x.payout_amount||0)}</td>
    </tr>
  `).join("") || `<tr><td colspan="3" class="sub">No payouts</td></tr>`;

  // histogram
  const labels = (members||[]).map(m=>m.name||"");
  const data = (members||[]).map(m=> totalsByMember[String(m.id)] || 0);

  if(histChart){ histChart.destroy(); histChart = null; }
  histChart = new Chart($("histChart"), {
    type: "bar",
    data: { labels, datasets: [{ label:"Contributions", data }] },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ display:false }},
      scales:{
        x:{ ticks:{ color:"#e5e7eb", autoSkip:false, maxRotation:60 }},
        y:{ ticks:{ color:"#e5e7eb" }, beginAtZero:true }
      }
    }
  });
}

/* =========================
   WRITES
========================= */
async function approveProfile(profileId){
  if(!isAdmin) return toast("Admin only");
  const up = await sb.from("profiles").update({ approved:true }).eq("id", profileId);
  if(up.error) return toast(up.error.message);
  toast("Approved");
  await reloadAll();
}

async function addMember(){
  if(!isAdmin) return toast("Admin only");
  const name = $("mName").value.trim();
  const email = $("mEmail").value.trim().toLowerCase();
  const phone = $("mPhone").value.trim();
  const hasBenefits = ($("mBenefits").value === "true");
  if(!name) return toast("Enter name");
  if(!email) return toast("Enter email");

  const pos = members.length ? (Math.max(...members.map(x=>Number(x.position||0))) + 1) : 1;
  const ins = await sb.from("members").insert([{ name, email, phone, has_benefits:hasBenefits, position:pos }]);
  if(ins.error) return toast(ins.error.message);

  $("mName").value=""; $("mEmail").value=""; $("mPhone").value="";
  toast("Member added");
  await reloadAll();
}

async function addContribution(){
  if(!isAdmin) return toast("Admin only");
  const member_id = $("cMember").value;
  const amount = Number($("cAmount").value||0);
  if(!member_id) return toast("Select member");
  if(amount<=0) return toast("Enter amount");
  if(amount % 500 !== 0) return toast("Must be multiple of 500");

  // try insert with kind; fallback without kind
  let ins = await sb.from("contributions").insert([{ member_id, amount, kind:"contribution" }]);
  if(ins.error){
    ins = await sb.from("contributions").insert([{ member_id, amount }]);
  }
  if(ins.error) return toast(ins.error.message);

  $("cAmount").value="";
  toast("Saved");
  await reloadAll();
}

async function requestLoan(){
  const borrower_member_id = (currentMemberId!=null) ? String(currentMemberId) : $("lBorrower").value;
  const surety_member_id = $("lSurety").value;
  const principal = Number($("lAmount").value||0);
  if(!borrower_member_id) return toast("Borrower missing");
  if(!surety_member_id) return toast("Select surety");
  if(principal<=0) return toast("Enter amount");

  const e = eligible(borrower_member_id, surety_member_id, principal);
  if(!e.ok) return toast(e.reason);

  const borrower = members.find(m=>String(m.id)===String(borrower_member_id));
  const surety = members.find(m=>String(m.id)===String(surety_member_id));

  const interest = Math.round(principal * INTEREST_RATE);
  const total_due = principal + interest;

  const ins = await sb.from("loans").insert([{
    borrower_member_id,
    borrower_name: borrower?.name || "",
    surety_member_id,
    surety_name: surety?.name || "",
    principal, interest, total_due,
    status: "pending",
    created_at: new Date().toISOString()
  }]);
  if(ins.error) return toast(ins.error.message);

  $("lAmount").value="";
  toast("Loan requested (pending)");
  await reloadAll();
}

async function createActiveLoanAdmin(){
  if(!isAdmin) return toast("Admin only");

  const borrower_member_id = $("lBorrower").value;
  const surety_member_id = $("lSurety").value;
  const principal = Number($("lAmount").value||0);
  if(!borrower_member_id) return toast("Select borrower");
  if(!surety_member_id) return toast("Select surety");
  if(principal<=0) return toast("Enter amount");

  const e = eligible(borrower_member_id, surety_member_id, principal);
  if(!e.ok) return toast(e.reason);

  const borrower = members.find(m=>String(m.id)===String(borrower_member_id));
  const surety = members.find(m=>String(m.id)===String(surety_member_id));
  const interest = Math.round(principal * INTEREST_RATE);
  const total_due = principal + interest;

  const foundation = Number(appState.foundation||0);
  if(principal > foundation) return toast("Not enough foundation");

  const ins = await sb.from("loans").insert([{
    borrower_member_id,
    borrower_name: borrower?.name || "",
    surety_member_id,
    surety_name: surety?.name || "",
    principal, interest, total_due,
    status: "active",
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  }]);
  if(ins.error) return toast(ins.error.message);

  const upM = await sb.from("members").update({
    loan_due: Number(borrower?.loan_due||0) + total_due
  }).eq("id", borrower_member_id);
  if(upM.error) return toast("members update: " + upM.error.message);

  const upS = await sb.from("app_state").update({
    foundation: foundation - principal,
    total_interest_generated: Number(appState.total_interest_generated||0) + interest,
    updated_at: new Date().toISOString()
  }).eq("id", 1);
  if(upS.error) return toast("app_state update: " + upS.error.message);

  $("lAmount").value="";
  toast("Active loan created");
  await reloadAll();
}

async function approveLoan(loanId){
  if(!isAdmin) return toast("Admin only");

  const got = await sb.from("loans").select("*").eq("id", loanId).single();
  if(got.error) return toast("fetch: " + got.error.message);
  const loan = got.data;

  if(String(loan.status||"").toLowerCase() !== "pending") return toast("Not pending");

  const foundation = Number(appState.foundation||0);
  const principal = Number(loan.principal||0);
  const interest = Number(loan.interest||0);
  const total_due = Number(loan.total_due||0);

  if(principal > foundation) return toast("Not enough foundation to approve");

  const upLoan = await sb.from("loans").update({
    status:"active",
    updated_at:new Date().toISOString()
  }).eq("id", loanId);
  if(upLoan.error) return toast("approve: " + upLoan.error.message);

  const borrower = members.find(m=>String(m.id)===String(loan.borrower_member_id));
  const upM = await sb.from("members").update({
    loan_due: Number(borrower?.loan_due||0) + total_due
  }).eq("id", loan.borrower_member_id);
  if(upM.error) return toast("members: " + upM.error.message);

  const upS = await sb.from("app_state").update({
    foundation: foundation - principal,
    total_interest_generated: Number(appState.total_interest_generated||0) + interest,
    updated_at: new Date().toISOString()
  }).eq("id", 1);
  if(upS.error) return toast("app_state: " + upS.error.message);

  toast("Approved ✅");
  await reloadAll();
}

async function runPayout(){
  if(!isAdmin) return toast("Admin only");
  if(!members.length) return toast("No members");

  // pot = sum of contributions
  const totalsByMember = {};
  for(const r of contributions){
    const k = String(r.member_id);
    totalsByMember[k] = (totalsByMember[k]||0) + Number(r.amount||0);
  }
  const potSum = Object.values(totalsByMember).reduce((s,v)=>s+v,0);
  if(potSum <= 0) return toast("Pot is 0");

  const idx = Number(appState.next_payout_index || 0);
  const payIndex = idx % members.length;
  const payMember = members[payIndex];
  const payout_date = (appState.next_payout_date || new Date().toISOString().slice(0,10));

  const ins = await sb.from("payouts").insert([{
    member_id: payMember.id,
    member_name: payMember.name,
    payout_amount: potSum,
    payout_date,
    created_at: new Date().toISOString()
  }]);
  if(ins.error) return toast(ins.error.message);

  const upM = await sb.from("members").update({
    payout_total: Number(payMember.payout_total||0) + potSum
  }).eq("id", payMember.id);
  if(upM.error) return toast("member payout_total: " + upM.error.message);

  // advance 14 days + index
  const d = new Date(payout_date + "T00:00:00");
  d.setDate(d.getDate() + 14);
  const nextDate = d.toISOString().slice(0,10);

  const upS = await sb.from("app_state").update({
    next_payout_index: idx + 1,
    next_payout_date: nextDate,
    updated_at: new Date().toISOString()
  }).eq("id", 1);
  if(upS.error) return toast("app_state: " + upS.error.message);

  toast(`Payout done → ${payMember.name}`);
  await reloadAll();
}

/* =========================
   INIT
========================= */
document.addEventListener("DOMContentLoaded", async ()=>{
  $("tabSignIn").onclick = ()=>setAuthMode("signin");
  $("tabSignUp").onclick = ()=>setAuthMode("signup");
  $("btnAuth").onclick = ()=> (AUTH_MODE==="signup" ? signUp() : signIn());
  $("btnLogout").onclick = signOut;
  $("btnRefresh").onclick = reloadAll;

  // nav
  document.querySelectorAll(".nav button[data-sec]").forEach(b=>{
    b.onclick = ()=>{
      const sec = b.getAttribute("data-sec");
      const title = b.textContent.trim();
      const hint = (sec==="dash") ? "Overview + histogram"
        : (sec==="members") ? "Admin: add members + approve logins"
        : (sec==="contrib") ? "Admin: add contributions"
        : (sec==="loans") ? "Member: request. Admin: approve."
        : "Admin: run payouts";
      showSection(sec, title, hint);
    };
  });

  // admin actions
  $("btnAddMember").onclick = addMember;
  $("btnAddContrib").onclick = addContribution;

  // payout buttons (both)
  $("btnRunPayout").onclick = runPayout;
  $("btnRunPayout2").onclick = runPayout;

  // loan action depends on role
  $("btnLoanAction").onclick = async ()=>{
    if(isAdmin) return createActiveLoanAdmin();
    return requestLoan();
  };

  setAuthMode("signin");

  // auto restore session
  try{
    const ok = await enforceGate();
    if(ok){
      await reloadAll();
      toast("Session restored");
    }
  }catch(e){
    // stay on login
  }
});
</script>

</body>
</html>
