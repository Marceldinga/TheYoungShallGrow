<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TheYoungShallGrow Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* ===========================
       BUSINESS THEME (PRO UI)
    =========================== */
    :root{
      --primary:#1f4b99;
      --primary2:#2a6adf;
      --accent:#14b8a6;
      --danger:#ef4444;
      --warning:#f59e0b;
      --success:#22c55e;

      --bg:#0b1220;
      --bg2:#111827;
      --card:#151c2f;
      --card2:#1b2440;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#253056;

      --shadow: 0 14px 40px rgba(15, 23, 42, .35);
      --shadow2: 0 8px 20px rgba(15, 23, 42, .25);
      --radius:18px;

      --ring: 0 0 0 4px rgba(42,106,223,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 15% 0%, rgba(42,106,223,.18), transparent 55%),
        radial-gradient(900px 600px at 85% 15%, rgba(20,184,166,.12), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      min-height:100vh;
    }

    /* ===========================
       LOGIN
    =========================== */
    #locked{
      display:flex;align-items:center;justify-content:center;
      min-height:100vh;padding:22px;
    }
    .lockBox{
      width:min(520px,100%);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      padding:18px;
      box-shadow:var(--shadow);
    }
    .lockTop{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;margin-bottom:10px;
    }
    .brandMini{
      display:flex;align-items:center;gap:10px;
      font-weight:900; letter-spacing:.2px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:linear-gradient(135deg, var(--primary2), var(--accent));
      box-shadow:0 0 18px rgba(42,106,223,.25);
    }
    .authTabs{display:flex;gap:10px;margin:10px 0 10px}
    .authTabs button{flex:1}
    .authHint{
      font-size:12px;color:var(--muted);
      padding:10px 12px;
      background:rgba(42,106,223,.10);
      border:1px dashed rgba(42,106,223,.25);
      border-radius:14px;
      margin-bottom:10px;
    }

    input,select,textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card2);
      color:var(--text);
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease, transform .08s ease;
    }
    input::placeholder,textarea::placeholder{color:#94a3b8}
    textarea{min-height:96px;resize:vertical}

    input:focus,select:focus,textarea:focus{
      border-color: rgba(42,106,223,.45);
      box-shadow: var(--ring);
      background:var(--card2);
    }

    .btn{
      padding:11px 14px;
      border-radius:14px;
      border:1px solid rgba(31,75,153,.35);
      background: linear-gradient(135deg, rgba(42,106,223,.20), rgba(20,184,166,.12));
      color:var(--text);
      cursor:pointer;
      box-shadow:var(--shadow2);
      transition: transform .08s ease, filter .10s ease, box-shadow .12s ease;
      font-weight:700;
    }
    .btn:hover{filter:brightness(1.03)}
    .btn:active{transform: translateY(1px)}
    .btn.ghost{
      background:var(--card2);
      box-shadow:none;
      border-color: var(--border);
      font-weight:700;
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(31,75,153,.98), rgba(42,106,223,.95));
      color:#fff;
      border-color: rgba(31,75,153,.30);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed;filter:grayscale(20%);box-shadow:none}

    .lockGrid{display:grid;grid-template-columns:1fr;gap:10px}
    .err{
      color:#fecaca;
      background:rgba(239,68,68,.10);
      border:1px solid rgba(239,68,68,.25);
      padding:10px 12px;border-radius:14px;
      white-space:pre-wrap;font-size:12px;
      display:none;
    }

    /* ===========================
       APP LAYOUT
    =========================== */
    .wrap{display:flex;min-height:100vh}
    .sidebar{
      width:330px;
      padding:16px;
      border-right:1px solid var(--border);
      background:rgba(21,28,47,.92);
      backdrop-filter: blur(10px);
    }
    .main{flex:1;padding:18px}

    .brand{
      font-weight:900;
      font-size:16px;
      letter-spacing:.2px;
      display:flex;align-items:center;gap:10px;
    }
    .sub{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.4}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      margin-top:14px;
      box-shadow:var(--shadow2);
    }
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(31,75,153,.10);
      font-size:12px;
      color:var(--text);
      white-space:nowrap;
    }
    .pill b{font-weight:900}

    .nav{display:flex;flex-direction:column;gap:8px;margin-top:14px}
    .nav button{
      width:100%;
      text-align:left;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card2);
      color:var(--text);
      cursor:pointer;
      transition: box-shadow .12s ease, transform .06s ease, border-color .12s ease;
      font-weight:800;
    }
    .nav button:hover{
      border-color: rgba(42,106,223,.35);
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
    }
    .nav button.active{
      border-color: rgba(42,106,223,.55);
      box-shadow: 0 0 0 3px rgba(42,106,223,.18) inset;
      background: rgba(42,106,223,.14);
      color: var(--text);
    }

    .topbar{
      display:flex;justify-content:space-between;align-items:flex-start;
      gap:12px;margin-bottom:14px
    }
    .titleWrap{display:flex;flex-direction:column;gap:4px}
    .title{font-size:18px;font-weight:900}
    .subtitleSmall{font-size:12px;color:var(--muted)}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kpi{position:relative;overflow:hidden;}
    .kpi:before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(135deg, rgba(42,106,223,.10), rgba(20,184,166,.08));
      pointer-events:none;
    }
    .kpi > *{position:relative}
    .kpi .label{color:var(--muted);font-size:12px;font-weight:800}
    .kpi .val{font-size:22px;font-weight:1000;margin-top:6px;letter-spacing:.2px}
    .section{display:none}
    .section.active{display:block}

    label{
      display:block;
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
      font-weight:800;
    }

    /* ===========================
       TABLES
    =========================== */
    .tableWrap{overflow:auto;border-radius:14px;border:1px solid var(--border);margin-top:10px}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:720px;background:var(--card)}
    th,td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      font-size:12px;
      vertical-align:top;
    }
    th{
      color:var(--muted);
      font-weight:900;
      background:#1f2937;
      position:sticky; top:0; z-index:1;
    }
    tbody tr:nth-child(even) td{background:#19213a}
    tbody tr:hover td{background:rgba(42,106,223,.12)}
    .tdMoney{text-align:right;font-variant-numeric: tabular-nums;}
    .tdCenter{text-align:center}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:5px 10px;border-radius:999px;
      font-size:11px;font-weight:900;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .badge::before{
      content:"";
      width:8px;height:8px;border-radius:999px;
      background: currentColor;
      opacity:.95;
      box-shadow:0 0 0 3px rgba(0,0,0,.12);
    }
    .b-pending{color:#f59e0b;background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.25)}
    .b-active{color:#60a5fa;background:rgba(59,130,246,.12);border-color:rgba(59,130,246,.25)}
    .b-cleared{color:#34d399;background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.25)}
    .b-paid{color:#34d399;background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.25)}
    .b-unpaid{color:#f87171;background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.25)}
    .b-partial{color:#2dd4bf;background:rgba(20,184,166,.12);border-color:rgba(20,184,166,.22)}
    .b-unknown{color:#cbd5e1;background:rgba(148,163,184,.14);border-color:rgba(148,163,184,.22)}

    .helper{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      background:rgba(31,75,153,.10);
      border:1px solid rgba(31,75,153,.18);
      padding:10px 12px;border-radius:14px;
    }

    #toast{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
      background:rgba(15,23,42,.92);
      color:#fff;
      padding:10px 14px;
      border-radius:14px;
      box-shadow:var(--shadow);
      display:none;
      z-index:9999;
      max-width:min(560px,92vw);
      font-size:13px;
    }

    .chartWrap{position:relative;}
    .noDataOverlay{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      text-align:center;
      color:var(--muted);
      font-size:12px;
      pointer-events:none;
      padding:8px;
    }
    .noDataOverlay .box{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card2);
      max-width:90%;
      box-shadow:var(--shadow2);
    }

    @media (max-width:1100px){
      .grid4{grid-template-columns:1fr 1fr}
      .grid2{grid-template-columns:1fr}
      .sidebar{width:100%;max-width:360px}
    }
    @media (max-width:740px){
      .wrap{flex-direction:column}
      .sidebar{max-width:none;border-right:none;border-bottom:1px solid var(--border)}
      .main{padding:14px}
      table{min-width:640px}
    }
  </style>
</head>

<body>

<!-- LOGIN / SIGNUP -->
<div id="locked">
  <div class="lockBox">
    <div class="lockTop">
      <div class="brandMini"><span class="dot"></span> TheYoungShallGrow</div>
      <span class="pill">Secure Login</span>
    </div>

    <div class="sub">Sign in to manage Njangi contributions, loans, and payouts.</div>

    <div class="authTabs">
      <button id="tabSignIn" class="btn primary" onclick="setAuthMode('signin')">Sign in</button>
      <button id="tabSignUp" class="btn ghost" onclick="setAuthMode('signup')">Sign up</button>
    </div>

    <div class="lockGrid">
      <div id="signupFields" style="display:none;">
        <div class="authHint">
          ✅ Sign up is allowed ONLY if your email is already registered by Admin in <b>members.email</b>.
          <br>After sign up, your login is <b>pending</b> until admin approves.
        </div>
      </div>

      <input id="email" placeholder="Email" autocomplete="username" />
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" />

      <button id="btnAuth" class="btn primary" onclick="signIn()">Sign in</button>
      <div id="lockErr" class="err"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="wrap" style="display:none;">
  <aside class="sidebar">
    <div class="brand"><span class="dot"></span> TheYoungShallGrow: Dashboard</div>
    <div class="sub">Today • <span id="today"></span></div>

    <div class="card">
      <div class="row"><span class="sub">Signed in</span><span class="pill" id="who">—</span></div>
      <div class="row" style="margin-top:10px;"><span class="sub">Role</span><span class="pill" id="role">—</span></div>
      <button class="btn ghost" style="width:100%;margin-top:10px" onclick="signOut()">Logout</button>
      <div id="sideErr" class="err"></div>
    </div>

    <div class="nav">
      <button id="navDash" class="active" onclick="show('dash','Dashboard')">Dashboard</button>
      <button id="navMembers" onclick="show('members','Members')">Members</button>
      <button id="navContrib" onclick="show('contrib','Contributions')">Contributions</button>
      <button id="navLoans" onclick="show('loans','Loans')">Loans</button>
      <button id="navFines" onclick="show('fines','Fines')">Fines</button>
      <button id="navPayouts" onclick="show('payouts','Payouts')">Payouts</button>
      <button id="navHistory" onclick="show('history','History')">History</button>
      <button id="navFPayments" onclick="show('foundation_payments','Foundation Payments')">Foundation Payments</button>

      <button class="btn ghost" style="margin-top:6px" onclick="reloadAll()">Refresh</button>
    </div>

    <div class="card">
      <div class="sub"><b>Rotation</b></div>
      <div style="margin-top:8px;font-weight:1000;font-size:18px" id="nextName">—</div>
      <div class="sub" id="nextInfo">—</div>
      <button class="btn primary" style="width:100%;margin-top:10px" onclick="runPayout()">Run Payout</button>
      <div class="sub" style="margin-top:10px;">Start: <b>Jan 3, 2026</b> • Every 14 days</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="titleWrap">
        <div class="title" id="pageTitle">Dashboard</div>
        <div class="subtitleSmall" id="roleHint">Business overview and recent activity</div>
      </div>

      <span class="pill">Total Interest: <b id="kInterestMini">$0</b></span>
    </div>

    <section id="dash" class="section active">
      <div class="grid4">
        <div class="card kpi">
          <div class="label">Njangi Pot</div>
          <div class="val" id="kPot">$0</div>
          <div class="sub">Sum of contributions</div>
        </div>
        <div class="card kpi">
          <div class="label">Foundation</div>
          <div class="val" id="kFoundation">$0</div>
          <div class="sub">Available for loans</div>
        </div>
        <div class="card kpi">
          <div class="label">Outstanding Loans</div>
          <div class="val" id="kLoans">$0</div>
          <div class="sub">Total due</div>
        </div>
        <div class="card kpi">
          <div class="label">Members</div>
          <div class="val" id="kMembers">0</div>
          <div class="sub">Rotation list</div>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div class="card">
          <div class="row"><div style="font-weight:1000;">Histogram: Contributions (All Members)</div><span class="pill">Now</span></div>
          <div class="chartWrap" style="height:170px;margin-top:10px;">
            <canvas id="histChart"></canvas>
            <div id="histNoData" class="noDataOverlay">
              <div class="box"><b>No contribution data yet.</b><br><span class="sub">Add a contribution to see the chart.</span></div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="row"><div style="font-weight:1000;">Pie: Pot vs Foundation vs Loans</div><span class="pill">Now</span></div>
          <div class="chartWrap" style="height:170px;margin-top:10px;">
            <canvas id="pieChart"></canvas>
            <div id="pieNoData" class="noDataOverlay">
              <div class="box"><b>No values yet.</b><br><span class="sub">Pot / Foundation / Loans are all 0.</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="row"><div style="font-weight:1000;">Recent Activity</div><span class="pill">Top 15</span></div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Time</th><th>Type</th><th>Member</th>
                <th class="tdMoney">Amount</th><th class="tdCenter">Interest %</th><th class="tdMoney">Total Due</th>
              </tr>
            </thead>
            <tbody id="recentBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="members" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:1000;">Add Member (Admin registers email here)</div>
          <div class="helper">Members can only sign up if their email is registered here first.</div>

          <label>Name</label><input id="mName" placeholder="e.g. John Doe" />
          <label>Email (required for signup)</label><input id="mEmail" placeholder="e.g. john@email.com" />
          <label>Phone (optional)</label><input id="mPhone" placeholder="e.g. 301-000-0000" />
          <label>Has benefits?</label>
          <select id="mBenefits"><option value="false">No</option><option value="true">Yes</option></select>
          <button class="btn primary" style="width:100%;margin-top:12px" onclick="addMember()">Add Member</button>

          <hr style="border:0;border-top:1px solid var(--border);margin:14px 0;">

          <div style="font-weight:1000;">Approve Pending Logins (Admin)</div>
          <div class="sub" style="margin-top:6px;">Members who signed up will appear here until approved.</div>

          <div class="tableWrap">
            <table>
              <thead><tr><th>Email</th><th>Member</th><th>Status</th><th>Action</th></tr></thead>
              <tbody id="approveBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="row"><div style="font-weight:1000;">Member List</div><span class="pill">Total: <span id="memberCount">0</span></span></div>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Name</th><th>Email</th>
                  <th class="tdMoney">Njangi</th>
                  <th class="tdMoney">Foundation</th>
                  <th class="tdMoney">Loan Due</th>
                  <th class="tdMoney">Payout Total</th>
                  <th class="tdCenter">Benefits</th>
                </tr>
              </thead>
              <tbody id="memberBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="contrib" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:1000;">Add Contribution</div>
          <label>Member</label><select id="cMember"></select>
          <label>Amount (multiple of 500)</label><input id="cAmount" type="number" placeholder="e.g. 500" />
          <button class="btn primary" style="width:100%;margin-top:12px" onclick="addContribution()">Save Contribution</button>
          <div class="helper">Rule: Contributions must be multiples of <b>500</b>.</div>
        </div>
        <div class="card">
          <div style="font-weight:1000;">Contributions Info</div>
          <div class="sub" style="margin-top:6px">This page records contributions into Supabase.</div>
        </div>
      </div>
    </section>

    <section id="loans" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:1000;" id="loanBoxTitle">Issue Loan (5%) — Saved into Loans + Deducts Foundation Pot</div>

          <label>Surety (select member)</label><select id="lSuretyMember"></select>
          <label>Borrower (select member)</label><select id="lMember"></select>
          <label>Loan amount</label><input id="lAmount" type="number" placeholder="e.g. 1000" />
          <button id="btnLoanAction" class="btn primary" style="width:100%;margin-top:12px" onclick="issueLoan()">Issue Loan</button>

          <div class="helper" id="loanRules">
            <b>Rules</b>
            <br>1) Eligibility uses: contribution_total + (foundation_contrib * 0.70)
            <br>2) If borrower total >= amount → eligible (self). Else needs surety whose total helps reach amount.
            <br>3) 15-days rule auto-converts pending foundation payments to loans (independent of surety).
            <br>4) Interest: 5% at borrow + every 26 days; unpaid interest compounds into principal.
          </div>

          <hr style="border:0;border-top:1px solid var(--border);margin:14px 0;">

          <div style="font-weight:1000;">Record Repayment</div>
          <label>Borrower (select member)</label><select id="rMember"></select>
          <label>Repayment amount</label><input id="rAmount" type="number" placeholder="e.g. 500" />
          <button class="btn primary" style="width:100%;margin-top:12px" onclick="repayLoan()">Save Repayment</button>
        </div>

        <div class="card">
          <div class="row"><div style="font-weight:1000;">Loans</div><span class="pill">Newest first</span></div>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Date</th><th>Borrower</th><th>Surety</th>
                  <th class="tdMoney">Principal</th>
                  <th class="tdMoney">Interest (Total)</th>
                  <th class="tdMoney">Total Due</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="loanBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="fines" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:1000;">Add Fine</div>
          <label>Member</label><select id="fineMember"></select>
          <label>Fine amount</label><input id="fineAmount" type="number" placeholder="e.g. 500" />
          <label>Reason</label><input id="fineReason" placeholder="Late payment..." />
          <button class="btn primary" style="width:100%;margin-top:12px" onclick="addFine()">Save Fine</button>
        </div>

        <div class="card">
          <div class="row"><div style="font-weight:1000;">Fines</div><span class="pill">Newest first</span></div>
          <div class="tableWrap">
            <table>
              <thead><tr><th>Date</th><th>Member</th><th class="tdMoney">Amount</th><th>Reason</th><th>Status</th><th>Action</th></tr></thead>
              <tbody id="fineBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="payouts" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:1000;">Run Payout</div>
          <div class="sub" style="margin-top:6px;">Start: Jan 3, 2026 • Every 14 days</div>
          <button class="btn primary" style="width:100%;margin-top:12px" onclick="runPayout()">Run Now</button>
        </div>

        <div class="card">
          <div style="font-weight:1000;">Payout History</div>
          <div class="tableWrap">
            <table>
              <thead><tr><th>Date</th><th>Member</th><th class="tdMoney">Amount</th></tr></thead>
              <tbody id="payoutBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="history" class="section">
      <div class="card">
        <div class="row"><div style="font-weight:1000;">Full History</div><span class="pill">Latest first</span></div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Time</th><th>Type</th><th>Member</th>
                <th class="tdMoney">Amount</th><th class="tdCenter">Interest %</th><th class="tdMoney">Total Due</th>
              </tr>
            </thead>
            <tbody id="historyBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="foundation_payments" class="section">
      <div class="grid2">
        <div class="card">
          <div style="font-weight:1000;">Add Foundation Payment</div>
          <label>Member</label><select id="fpMember"></select>
          <label>Amount Paid</label><input id="fpPaid" type="number" placeholder="e.g. 500" />
          <label>Amount Pending</label><input id="fpPending" type="number" placeholder="e.g. 1500" />
          <label>Status</label>
          <select id="fpStatus">
            <option value="pending">pending</option>
            <option value="partial">partial</option>
            <option value="paid">paid</option>
          </select>
          <label>Notes (optional)</label><textarea id="fpNotes" placeholder="Notes..."></textarea>
          <button class="btn primary" style="width:100%;margin-top:12px" onclick="addFoundationPayment()">Save</button>
          <div class="sub" style="margin-top:10px">DatePaid is auto (now()).</div>
        </div>

        <div class="card">
          <div class="row"><div style="font-weight:1000;">Foundation Payments</div><span class="pill">Newest first</span></div>
          <div class="tableWrap">
            <table>
              <thead><tr><th>Date</th><th>Member</th><th class="tdMoney">Paid</th><th class="tdMoney">Pending</th><th>Status</th><th>Notes</th></tr></thead>
              <tbody id="fpBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<div id="toast"></div>

<script>
/* ===========================
   SUPABASE CONFIG (UNCHANGED)
=========================== */
const SUPABASE_URL = "https://ficlrtvrrzfiakmciwel.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpY2xydHZycnpmaWFrbWNpd2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjk0MDQsImV4cCI6MjA4MjcwNTQwNH0.xWuH_-amYd_24R8PURbZXMUDjz--Q9R_RASOdGzsZJI";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
});

/* ===========================
   CONSTANTS (YOUR PROMPTS)
=========================== */
const ROTATION_START = new Date("2026-01-03T00:00:00");
const FOUNDATION_FACTOR = 0.70;
const FOUNDATION_PENDING_MAX_DAYS = 15;

const INTEREST_RATE = 0.05;
const INTEREST_CYCLE_DAYS = 26;

/* ===========================
   STATE
=========================== */
let appState = { foundation:0, total_interest_generated:0, next_payout_index:0, next_payout_date:"2026-01-03", rotation_start_date:"2026-01-03" };
let members = [];
let history = [];
let payouts = [];
let fines = [];
let foundationPayments = [];
let loans = [];
let latestSession = null;

let contribTotalsByMember = {};
let histChart = null;
let pieChart = null;

window.isAdmin = false;
window.currentMemberId = null;
window.profileApproved = false;
let profiles = [];

/* ===========================
   HELPERS
=========================== */
const money = (x) => "$" + (Number(x)||0).toLocaleString();
const fromIso = (s) => new Date(s + "T00:00:00");

function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(() => { el.style.display = "none"; }, 2800);
}
function sideErr(msg){
  const el = document.getElementById("sideErr");
  el.style.display = msg ? "block" : "none";
  el.textContent = msg || "";
}
function appendErr(msg){
  const el = document.getElementById("sideErr");
  const current = el.textContent || "";
  const next = current ? (current + "\n" + msg) : msg;
  el.style.display = "block";
  el.textContent = next;
}
function lockErr(msg){
  const el = document.getElementById("lockErr");
  el.style.display = msg ? "block" : "none";
  el.textContent = msg || "";
}

function badgeForStatus(statusRaw){
  const s = String(statusRaw || "").toLowerCase().trim();
  if(s === "pending") return `<span class="badge b-pending">Pending</span>`;
  if(s === "active") return `<span class="badge b-active">Active</span>`;
  if(s === "cleared") return `<span class="badge b-cleared">Cleared</span>`;
  if(s === "paid") return `<span class="badge b-paid">Paid</span>`;
  if(s === "unpaid") return `<span class="badge b-unpaid">Unpaid</span>`;
  if(s === "partial") return `<span class="badge b-partial">Partial</span>`;
  return `<span class="badge b-unknown">${statusRaw || "—"}</span>`;
}

function show(sectionId, title){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(sectionId).classList.add("active");
  document.getElementById("pageTitle").textContent = title;

  const hint = document.getElementById("roleHint");
  if(hint){
    hint.textContent = (sectionId === "dash") ? "Business overview and recent activity"
      : (sectionId === "members") ? "Manage members and approve new logins"
      : (sectionId === "contrib") ? "Record member contributions"
      : (sectionId === "loans") ? "Request, approve, and track loans"
      : (sectionId === "fines") ? "Track fines and payment status"
      : (sectionId === "payouts") ? "Run payouts and review history"
      : (sectionId === "history") ? "Full audit history (latest first)"
      : "Record foundation payments and pending balances";
  }

  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  const map = {
    dash:"navDash",
    members:"navMembers",
    contrib:"navContrib",
    loans:"navLoans",
    fines:"navFines",
    payouts:"navPayouts",
    history:"navHistory",
    foundation_payments:"navFPayments",
  };
  document.getElementById(map[sectionId])?.classList.add("active");
}

window.addEventListener("error", (e) => appendErr("JS error: " + (e?.message || "unknown")));
window.addEventListener("unhandledrejection", (e) => appendErr("Promise error: " + (e?.reason?.message || String(e?.reason || "unknown"))));

/* ===========================
   AUTH MODE (signin/signup)
=========================== */
let AUTH_MODE = "signin";
function setAuthMode(mode){
  AUTH_MODE = mode === "signup" ? "signup" : "signin";

  const su = document.getElementById("signupFields");
  const btn = document.getElementById("btnAuth");
  const tabIn = document.getElementById("tabSignIn");
  const tabUp = document.getElementById("tabSignUp");

  if(AUTH_MODE === "signup"){
    su.style.display = "block";
    btn.textContent = "Create account";
    btn.setAttribute("onclick","signUp()");
    tabUp.classList.remove("ghost");
    tabUp.classList.add("primary");
    tabIn.classList.add("ghost");
    tabIn.classList.remove("primary");
  }else{
    su.style.display = "none";
    btn.textContent = "Sign in";
    btn.setAttribute("onclick","signIn()");
    tabIn.classList.remove("ghost");
    tabIn.classList.add("primary");
    tabUp.classList.add("ghost");
    tabUp.classList.remove("primary");
  }
  lockErr("");
}

/* ===========================
   SEASON DATE / DAY COUNT
=========================== */
function getSeasonStartDate(){
  const s = (appState && appState.rotation_start_date) ? String(appState.rotation_start_date) : null;
  if(s && /^\d{4}-\d{2}-\d{2}$/.test(s)) return fromIso(s);
  return ROTATION_START;
}
function daysSinceSeasonStart(){
  const start = getSeasonStartDate();
  const ms = Date.now() - start.getTime();
  return Math.floor(ms / (24*60*60*1000));
}

/* ===========================
   BORROW ELIGIBILITY (YOUR PROMPT A)
   member_total = contrib + foundation*0.70
   surety_total = contrib + foundation*0.70
=========================== */
function memberTotals(memberId){
  const mem = members.find(m => String(m.id) === String(memberId));
  if(!mem) return { contrib:0, foundation:0, total:0 };
  const contrib = Number(contribTotalsByMember[String(mem.id)] || 0);
  const foundation = Number(mem.foundation_contrib || 0);
  const total = contrib + (foundation * FOUNDATION_FACTOR);
  return { contrib, foundation, total };
}

function eligibilityDecision(borrowerId, suretyId, requestedAmount){
  const amt = Number(requestedAmount || 0);
  if(!amt || amt <= 0) return { ok:false, reason:"Enter a valid amount" };

  const b = memberTotals(borrowerId);
  if(b.total >= amt){
    return { ok:true, mode:"self", reason:`Eligible (self): borrower_total=${b.total.toFixed(2)} >= ${amt}` };
  }

  if(!suretyId) return { ok:false, reason:`Not eligible alone (borrower_total=${b.total.toFixed(2)}). Select surety.` };

  const s = memberTotals(suretyId);
  if((b.total + s.total) >= amt){
    return { ok:true, mode:"surety", reason:`Eligible (with surety): borrower_total+surety_total=${(b.total+s.total).toFixed(2)} >= ${amt}` };
  }

  return { ok:false, reason:`Not eligible: borrower_total+surety_total=${(b.total+s.total).toFixed(2)} < ${amt}` };
}

/* ===========================
   15-DAY AUTO CONVERSION (YOUR PROMPT B)
   Converts pending foundation_payment.amount_pending to loans
=========================== */
async function autoConvertPendingFoundationToLoans(){
  if(!window.isAdmin) return;

  const d = daysSinceSeasonStart();
  if(d < FOUNDATION_PENDING_MAX_DAYS) return;

  // Find all pending/partial with pending amount and not converted
  const fp = await sb.from("foundation_payments")
    .select("*")
    .in("status", ["pending","partial"])
    .gt("amount_pending", 0)
    .eq("converted_to_loan", false)
    .limit(500);

  if(fp.error){
    appendErr("autoConvert: foundation_payments: " + fp.error.message);
    return;
  }

  const rows = fp.data || [];
  if(!rows.length) return;

  for(const r of rows){
    const memberId = r.member_id;
    const principal = Number(r.amount_pending || 0);
    if(principal <= 0) continue;

    const mem = members.find(m => String(m.id) === String(memberId));
    const borrowerName = mem?.name || ("member_id=" + memberId);

    // 5% interest immediately
    const interest = Math.round(principal * INTEREST_RATE);
    const totalDue = principal + interest;

    // Create loan (AUTO_CONVERT: no surety)
    const ins = await sb.from("loans").insert([{
      borrower_member_id: memberId,
      borrower_name: borrowerName,
      surety_member_id: null,
      surety_name: "AUTO_CONVERT",
      principal: principal,
      principal_current: principal,
      interest: interest,
      total_due: totalDue,
      total_interest_accumulated: interest,
      borrow_date: new Date().toISOString().slice(0,10),
      last_interest_at: new Date().toISOString(),
      interest_cycle_days: INTEREST_CYCLE_DAYS,
      status: "active",
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    }]).select().single();

    if(ins.error){
      appendErr("autoConvert: loans insert: " + ins.error.message);
      continue;
    }

    const loanId = ins.data?.id;

    // Interest event ledger (initial)
    const led = await sb.from("loan_interest_events").insert([{
      loan_id: loanId,
      member_id: memberId,
      event_type: "initial",
      cycle_no: 0,
      principal_before: principal,
      interest_generated: interest,
      unpaid_interest_capitalized: 0,
      principal_after: principal
    }]);
    if(led.error) appendErr("autoConvert: ledger insert: " + led.error.message);

    // Update member loan_due (since they now owe)
    const curDue = Number(mem?.loan_due || 0);
    const upM = await sb.from("members").update({ loan_due: curDue + totalDue }).eq("id", memberId);
    if(upM.error) appendErr("autoConvert: members loan_due update: " + upM.error.message);

    // Mark foundation payment converted
    const upFP = await sb.from("foundation_payments").update({
      converted_to_loan: true,
      converted_loan_id: loanId,
      updated_at: new Date().toISOString(),
      notes: ((r.notes || "") + " | AUTO_CONVERTED_TO_LOAN").trim()
    }).eq("id", r.id);
    if(upFP.error) appendErr("autoConvert: foundation_payments update: " + upFP.error.message);

    // Track interest total in app_state + history
    const upS = await sb.from("app_state").update({
      total_interest_generated: Number(appState.total_interest_generated||0) + interest,
      updated_at: new Date().toISOString()
    }).eq("id", 1);
    if(upS.error) appendErr("autoConvert: app_state interest update: " + upS.error.message);

    await addHistoryRow("Foundation Pending Converted to Loan", borrowerName, principal, 5, totalDue);
  }
}

/* ===========================
   INTEREST ENGINE (YOUR PROMPT C)
   Every 26 days from borrow_date:
   - unpaid interest -> capitalized into principal_current
   - new 5% interest generated on new principal_current
   - ledger entry written
=========================== */
function daysBetween(a, b){
  const ms = b.getTime() - a.getTime();
  return Math.floor(ms / (24*60*60*1000));
}

async function runInterestEngine(){
  if(!window.isAdmin) return;

  // Load active loans from server (fresh)
  const l = await sb.from("loans").select("*").eq("status","active").limit(1000);
  if(l.error){ appendErr("interestEngine loans: " + l.error.message); return; }

  const activeLoans = l.data || [];
  const now = new Date();

  for(const loan of activeLoans){
    const loanId = loan.id;
    const memberId = loan.borrower_member_id;

    const borrowDateStr = loan.borrow_date || (loan.created_at ? String(loan.created_at).slice(0,10) : null);
    if(!borrowDateStr) continue;

    const borrowDate = fromIso(borrowDateStr);
    const cycleDays = Number(loan.interest_cycle_days || INTEREST_CYCLE_DAYS);

    const lastInterestAt = loan.last_interest_at ? new Date(loan.last_interest_at) : new Date(borrowDate.getTime());
    const passed = daysBetween(lastInterestAt, now);

    if(passed < cycleDays) continue;

    // How many full cycles are due since last_interest_at?
    const cyclesDue = Math.floor(passed / cycleDays);
    if(cyclesDue <= 0) continue;

    // Process each cycle sequentially (so compounding is correct)
    let principalCurrent = Number(loan.principal_current ?? loan.principal ?? 0);
    let totalDue = Number(loan.total_due ?? 0);
    let totalInterestAccum = Number(loan.total_interest_accumulated ?? 0);

    for(let i=0;i<cyclesDue;i++){
      // unpaid interest = total_due - principal_current (if positive)
      const unpaidInterest = Math.max(0, totalDue - principalCurrent);

      const principalBefore = principalCurrent;

      // capitalize unpaid interest into principal
      principalCurrent = principalCurrent + unpaidInterest;

      // generate new interest on new principal
      const interestGen = Math.round(principalCurrent * INTEREST_RATE);

      totalInterestAccum += interestGen;
      totalDue = principalCurrent + interestGen; // new due after cycle

      // ledger entry
      const ev = await sb.from("loan_interest_events").insert([{
        loan_id: loanId,
        member_id: memberId,
        event_type: "cycle",
        cycle_no: 1, // not strict sequencing; audit still preserved by created_at
        principal_before: principalBefore,
        unpaid_interest_capitalized: unpaidInterest,
        interest_generated: interestGen,
        principal_after: principalCurrent
      }]);
      if(ev.error) appendErr("interestEngine ledger: " + ev.error.message);

      // history row
      const mem = members.find(m => String(m.id) === String(memberId));
      await addHistoryRow("Interest Cycle (26 days)", mem?.name || ("member_id=" + memberId), interestGen, 5, totalDue);

      // update app_state interest total
      const upS = await sb.from("app_state").update({
        total_interest_generated: Number(appState.total_interest_generated||0) + interestGen,
        updated_at: new Date().toISOString()
      }).eq("id", 1);
      if(upS.error) appendErr("interestEngine app_state: " + upS.error.message);

      // update member loan_due (keep members in sync with loans)
      const memRow = members.find(m => String(m.id) === String(memberId));
      const curLoanDue = Number(memRow?.loan_due || 0);

      // Replace their due by recomputing from DB would be ideal; here we adjust:
      // subtract old loan total_due and add new totalDue.
      // We need previous total_due for this loan inside loop. We'll do it safely with server update below after loop,
      // and then reloadAll() to make members correct.
    }

    // Persist loan after all cycles
    const upLoan = await sb.from("loans").update({
      principal_current: principalCurrent,
      total_due: totalDue,
      total_interest_accumulated: totalInterestAccum,
      last_interest_at: now.toISOString(),
      updated_at: now.toISOString()
    }).eq("id", loanId);
    if(upLoan.error) appendErr("interestEngine loans update: " + upLoan.error.message);
  }
}

/* ===========================
   SURETY FILTERING (UI)
   We show sureties that make borrower eligible (or still allow selection)
=========================== */
function refreshSuretyDropdown(){
  const suretySel = document.getElementById("lSuretyMember");
  const borrowerSel = document.getElementById("lMember");
  const amtInput = document.getElementById("lAmount");
  if(!suretySel || !borrowerSel || !amtInput) return;

  const borrowerId = borrowerSel.value || "";
  const amt = Number(amtInput.value || 0);

  const opts = (members || []).map(m=>{
    // show all, but annotate eligibility quickly
    const dec = eligibilityDecision(borrowerId, m.id, amt);
    const label = dec.ok ? `✅ ${m.name}` : m.name;
    return `<option value="${m.id}">${label}</option>`;
  }).join("");

  suretySel.innerHTML = opts || `<option value="">No members</option>`;
}

/* ===========================
   AUTH / ROLE + APPROVAL GATE (UNCHANGED)
=========================== */
async function enforceAdminGate(){
  const { data } = await sb.auth.getUser();
  const user = data?.user;

  if(!user){
    document.getElementById("app").style.display = "none";
    document.getElementById("locked").style.display = "flex";
    return false;
  }

  const { data: profile, error } = await sb
    .from("profiles")
    .select("role, approved, member_id")
    .eq("id", user.id)
    .maybeSingle();

  if(error){
    sideErr("profiles: " + error.message);
    await sb.auth.signOut();
    document.getElementById("app").style.display = "none";
    document.getElementById("locked").style.display = "flex";
    return false;
  }

  if(!profile){
    sideErr("profiles: no row for this user (create a profiles row).");
    await sb.auth.signOut();
    document.getElementById("app").style.display = "none";
    document.getElementById("locked").style.display = "flex";
    return false;
  }

  window.isAdmin = (profile.role === "admin");
  window.currentMemberId = profile.member_id ?? null;
  window.profileApproved = !!profile.approved;

  if(!window.isAdmin && !window.profileApproved){
    await sb.auth.signOut();
    lockErr("Your account is pending admin approval. Please wait for admin to approve.");
    document.getElementById("app").style.display = "none";
    document.getElementById("locked").style.display = "flex";
    return false;
  }

  document.getElementById("locked").style.display = "none";
  document.getElementById("app").style.display = "flex";
  document.getElementById("who").textContent = user.email || "";
  document.getElementById("role").textContent = profile.role || "member";
  document.getElementById("today").textContent = new Date().toLocaleDateString();

  const pill = document.getElementById("kInterestMini")?.parentElement;
  if(pill) pill.style.display = window.isAdmin ? "inline-flex" : "none";

  const loanBtn = document.getElementById("btnLoanAction");
  const loanTitle = document.getElementById("loanBoxTitle");
  if(loanBtn && loanTitle){
    if(window.isAdmin){
      loanBtn.textContent = "Issue Loan";
      loanBtn.setAttribute("onclick","issueLoan()");
      loanTitle.textContent = "Issue Loan (5%) — Deducts Foundation Pot (Admin)";
    } else {
      loanBtn.textContent = "Request Loan";
      loanBtn.setAttribute("onclick","requestLoan()");
      loanTitle.textContent = "Request Loan (5%) — Status Pending until Admin Approves";
    }
  }

  const borrowerSel = document.getElementById("lMember");
  if(!window.isAdmin && borrowerSel){
    if(window.currentMemberId != null) borrowerSel.value = String(window.currentMemberId);
    borrowerSel.disabled = true;
  } else if(window.isAdmin && borrowerSel){
    borrowerSel.disabled = false;
  }

  if(!window.isAdmin){
    const disableSelectors = [
      "#members input", "#members select", "#members textarea", "#members button",
      "#contrib input", "#contrib select", "#contrib textarea", "#contrib button",
      "#fines input", "#fines select", "#fines textarea", "#fines button",
      "#payouts button",
      "#foundation_payments input", "#foundation_payments select", "#foundation_payments textarea", "#foundation_payments button"
    ];
    disableSelectors.forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=>{ el.disabled = true; });
    });
  } else {
    document.querySelectorAll("#app button, #app input, #app select, #app textarea").forEach(el=>{
      el.disabled = false;
    });
  }

  return true;
}

/* ===========================
   AUTH
=========================== */
async function signIn(){
  lockErr("");
  sideErr("");
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  if (!email || !password) return toast("Enter email and password");

  const { error } = await sb.auth.signInWithPassword({ email, password });
  if (error) return toast(error.message);

  const ok = await enforceAdminGate();
  if (!ok) return;

  await reloadAll();
  toast("Welcome");
}

async function signUp(){
  lockErr("");
  sideErr("");

  const email = document.getElementById("email").value.trim().toLowerCase();
  const password = document.getElementById("password").value;
  if(!email || !password) return toast("Enter email and password");

  const pre = await sb.from("members").select("id,name,email").eq("email", email).maybeSingle();
  if(pre.error) return toast("members lookup: " + pre.error.message);
  if(!pre.data) return toast("Signup blocked: your email is not registered by admin yet.");

  const { data, error } = await sb.auth.signUp({ email, password });
  if(error) return toast(error.message);

  const userId = data?.user?.id;
  if(!userId) return toast("Signup created, but user id missing. Try sign in.");

  const prof = await sb.from("profiles").upsert([{
    id: userId,
    role: "member",
    approved: false,
    member_id: pre.data.id
  }]);
  if(prof.error) lockErr("profiles upsert: " + prof.error.message);

  toast("Account created. Waiting for admin approval.");
  await sb.auth.signOut();
  setAuthMode("signin");
  lockErr("Your account is pending admin approval. Please wait.");
}

async function signOut(){
  await sb.auth.signOut();
  sideErr("");
  lockErr("");
  document.getElementById("app").style.display = "none";
  document.getElementById("locked").style.display = "flex";
}

/* ===========================
   LOAD
=========================== */
async function reloadAll(){
  sideErr("");

  // app_state
  let a = await sb.from("app_state").select("*").eq("id", 1).maybeSingle();
  if (a.error) {
    appendErr("app_state: " + a.error.message);
  } else if (!a.data) {
    const seed = {
      id: 1,
      foundation: 0,
      next_payout_index: 1,
      rotation_start_date: "2026-01-03",
      next_payout_date: "2026-01-03",
      total_interest_generated: 0,
      updated_at: new Date().toISOString()
    };
    const ins = await sb.from("app_state").insert([seed]).select().single();
    if (ins.error) appendErr("app_state init: " + ins.error.message);
    else appState = ins.data;
  } else {
    appState = a.data;
  }

  // members
  const m = await sb.from("members").select("*").order("position", { ascending: true });
  if (m.error) appendErr("members: " + m.error.message);
  members = m.data || [];

  // profiles
  const pr = await sb.from("profiles").select("id, role, approved, member_id");
  if(pr.error) appendErr("profiles: " + pr.error.message);
  profiles = pr.data || [];

  // contributions totals (must match supabase)
  const c = await sb.from("contributions").select("member_id, amount").eq("kind", "contribution").limit(5000);
  if (c.error) appendErr("contributions: " + c.error.message);

  const totals = {};
  (c.data || []).forEach(r => {
    const mid = String(r.member_id);
    totals[mid] = (totals[mid] || 0) + (Number(r.amount) || 0);
  });
  contribTotalsByMember = totals;
  members = (members || []).map(mem => ({ ...mem, contributed: totals[String(mem.id)] || 0 }));

  // history / payouts / fines / foundation_payments / loans / sessions
  const h = await sb.from("history").select("*").order("created_at", { ascending: false }).limit(500);
  if (h.error) appendErr("history: " + h.error.message);
  history = h.data || [];

  const p = await sb.from("payouts").select("*").order("created_at", { ascending: false }).limit(200);
  if (p.error) appendErr("payouts: " + p.error.message);
  payouts = p.data || [];

  const f = await sb.from("fines").select("*").order("created_at", { ascending: false }).limit(200);
  if (f.error) appendErr("fines: " + f.error.message);
  fines = f.data || [];

  const fp = await sb.from("foundation_payments").select("*").order("date_paid", { ascending: false }).limit(300);
  if (fp.error) appendErr("foundation_payments: " + fp.error.message);
  foundationPayments = fp.data || [];

  const l = await sb.from("loans").select("*").order("created_at", { ascending: false }).limit(300);
  if (l.error) appendErr("loans: " + l.error.message);
  loans = l.data || [];

  const sess = await sb.from("sessions").select("*").order("start_date", { ascending: false }).limit(1).maybeSingle();
  if (sess.error) appendErr("sessions: " + sess.error.message);
  latestSession = sess.data || null;

  // ✅ Apply prompt rules (admin only): 15-day conversion then interest engine
  await autoConvertPendingFoundationToLoans();
  await runInterestEngine();

  // Reload loans/members again after server updates (so UI matches Supabase)
  const m2 = await sb.from("members").select("*").order("position", { ascending: true });
  if(!m2.error) members = m2.data || members;

  const l2 = await sb.from("loans").select("*").order("created_at", { ascending: false }).limit(300);
  if(!l2.error) loans = l2.data || loans;

  const a2 = await sb.from("app_state").select("*").eq("id", 1).maybeSingle();
  if(!a2.error && a2.data) appState = a2.data;

  renderAll();

  const borrowerSel = document.getElementById("lMember");
  if(!window.isAdmin && borrowerSel && window.currentMemberId != null){
    borrowerSel.value = String(window.currentMemberId);
    borrowerSel.disabled = true;
  }

  refreshSuretyDropdown();
}

/* ===========================
   RENDER
=========================== */
function renderAll(){
  const pot = members.reduce((s,x)=>s+(Number(x.contributed)||0),0);
  const outstanding = loans
    .filter(l => String(l.status||"").toLowerCase() === "active")
    .reduce((s,l)=> s + (Number(l.total_due)||0), 0);

  document.getElementById("kPot").textContent = money(pot);
  document.getElementById("kFoundation").textContent = money(appState.foundation || 0);
  document.getElementById("kLoans").textContent = money(outstanding);
  document.getElementById("kMembers").textContent = String(members.length);
  document.getElementById("kInterestMini").textContent = money(appState.total_interest_generated||0);

  const idx = Number(appState.next_payout_index||0);
  const nextDate = appState.next_payout_date ? fromIso(appState.next_payout_date) : ROTATION_START;
  const nextMember = members.length ? members[idx % members.length] : null;

  document.getElementById("nextName").textContent = nextMember ? nextMember.name : "No members";
  document.getElementById("nextInfo").textContent = members.length
    ? `Next payout: ${nextDate.toLocaleDateString()} • Position ${(idx%members.length)+1}/${members.length} • Payout: ${money(pot)}`
    : "Add members to start rotation";

  document.getElementById("memberCount").textContent = String(members.length);

  // member list
  document.getElementById("memberBody").innerHTML = members
    .slice().sort((a,b)=>(a.name||"").localeCompare(b.name||""))
    .map(x=>`
      <tr>
        <td>${x.name||""}</td>
        <td>${x.email||""}</td>
        <td class="tdMoney">${money(x.contributed||0)}</td>
        <td class="tdMoney">${money(x.foundation_contrib||0)}</td>
        <td class="tdMoney">${money(x.loan_due||0)}</td>
        <td class="tdMoney">${money(x.payout_total||0)}</td>
        <td class="tdCenter">${x.has_benefits ? "Yes":"No"}</td>
      </tr>
    `).join("");

  // dropdown options
  const opts = members.map(x=>`<option value="${x.id}">${x.name}</option>`).join("");
  ["cMember","fineMember","fpMember","lMember","rMember"].forEach(id=>{
    const el=document.getElementById(id); if(el) el.innerHTML=opts;
  });

  // approvals
  const membersById = Object.fromEntries(members.map(m => [String(m.id), m]));
  const pending = (profiles || [])
    .filter(p => p.role === "member" && !p.approved && p.member_id != null);

  const approveBody = document.getElementById("approveBody");
  if(approveBody){
    approveBody.innerHTML = pending.map(p=>{
      const mem = membersById[String(p.member_id)];
      const action = window.isAdmin
        ? `<button class="btn ghost" onclick="approveProfile('${p.id}')">Approve</button>`
        : "-";
      return `<tr>
        <td>${mem?.email || "(email in members)"}</td>
        <td>${mem?.name || ("member_id=" + p.member_id)}</td>
        <td>${badgeForStatus("pending")}</td>
        <td>${action}</td>
      </tr>`;
    }).join("") || `<tr><td colspan="4" class="sub">No pending approvals</td></tr>`;
  }

  // recent + history
  const recent = history.slice(0,15);
  document.getElementById("recentBody").innerHTML = recent.map(x=>{
    const t=x.created_at?new Date(x.created_at).toLocaleString():"";
    return `<tr>
      <td>${t}</td>
      <td>${x.type||""}</td>
      <td>${x.member||""}</td>
      <td class="tdMoney">${money(x.amount||0)}</td>
      <td class="tdCenter">${x.interest_percent?Number(x.interest_percent)+"%":"-"}</td>
      <td class="tdMoney">${x.total_due!=null?money(x.total_due):"-"}</td>
    </tr>`;
  }).join("") || `<tr><td colspan="6" class="sub">No activity yet.</td></tr>`;

  document.getElementById("historyBody").innerHTML = history.map(x=>{
    const t=x.created_at?new Date(x.created_at).toLocaleString():"";
    return `<tr>
      <td>${t}</td>
      <td>${x.type||""}</td>
      <td>${x.member||""}</td>
      <td class="tdMoney">${money(x.amount||0)}</td>
      <td class="tdCenter">${x.interest_percent?Number(x.interest_percent)+"%":"-"}</td>
      <td class="tdMoney">${x.total_due!=null?money(x.total_due):"-"}</td>
    </tr>`;
  }).join("") || `<tr><td colspan="6" class="sub">No history yet.</td></tr>`;

  // payouts
  document.getElementById("payoutBody").innerHTML = payouts.map(x=>`
    <tr>
      <td>${x.payout_date||""}</td>
      <td>${x.member_name||""}</td>
      <td class="tdMoney">${money(x.payout_amount||0)}</td>
    </tr>
  `).join("") || `<tr><td colspan="3" class="sub">No payouts yet.</td></tr>`;

  // fines
  document.getElementById("fineBody").innerHTML = fines.map(x=>{
    const t=x.created_at?new Date(x.created_at).toLocaleString():"";
    const action = (x.status||"unpaid")==="unpaid"
      ? (window.isAdmin ? `<button class="btn ghost" onclick="markFinePaid(${x.id})">Mark Paid</button>` : "-")
      : "-";
    return `<tr>
      <td>${t}</td>
      <td>${x.member_name||""}</td>
      <td class="tdMoney">${money(x.amount||0)}</td>
      <td>${x.reason||"-"}</td>
      <td>${badgeForStatus(x.status||"unpaid")}</td>
      <td>${action}</td>
    </tr>`;
  }).join("") || `<tr><td colspan="6" class="sub">No fines recorded.</td></tr>`;

  // foundation payments
  document.getElementById("fpBody").innerHTML = (foundationPayments || []).map(r=>{
    const t = r.date_paid ? new Date(r.date_paid).toLocaleString() : "";
    const m = membersById[String(r.member_id)];
    return `<tr>
      <td>${t}</td>
      <td>${m ? m.name : (r.member_id ?? "")}</td>
      <td class="tdMoney">${money(r.amount_paid||0)}</td>
      <td class="tdMoney">${money(r.amount_pending||0)}</td>
      <td>${badgeForStatus(r.status||"")}</td>
      <td>${(r.notes||"")}</td>
    </tr>`;
  }).join("") || `<tr><td colspan="6" class="sub">No foundation payments recorded.</td></tr>`;

  // loans table
  document.getElementById("loanBody").innerHTML = (loans || []).map(r=>{
    const t = r.created_at ? new Date(r.created_at).toLocaleString() : "";
    const st = String(r.status || "");
    const canApprove = window.isAdmin && st.toLowerCase() === "pending";
    const action = canApprove
      ? `<button class="btn ghost" onclick="approveLoan(${r.id})">Approve</button>`
      : "-";
    const principalShown = (r.principal_current != null) ? r.principal_current : r.principal;
    const interestShown = (r.total_interest_accumulated != null) ? r.total_interest_accumulated : r.interest;
    return `<tr>
      <td>${t}</td>
      <td>${r.borrower_name || ""}</td>
      <td>${r.surety_name || ""}</td>
      <td class="tdMoney">${money(principalShown||0)}</td>
      <td class="tdMoney">${money(interestShown||0)}</td>
      <td class="tdMoney">${money(r.total_due||0)}</td>
      <td>${badgeForStatus(st)}</td>
      <td>${action}</td>
    </tr>`;
  }).join("") || `<tr><td colspan="8" class="sub">No loans yet.</td></tr>`;

  /* Charts: histogram shows TOTAL contributions per member */
  const membersInOrder = (members || []).slice().sort((a,b)=> (Number(a.position||0) - Number(b.position||0)));
  const histLabels = membersInOrder.map(m => m.name || "");
  const histData = membersInOrder.map(m => Number(m.contributed) || 0);
  const hasHistData = histData.some(v => (Number(v) || 0) > 0);

  const histOverlay = document.getElementById("histNoData");
  if(histOverlay) histOverlay.style.display = hasHistData ? "none" : "flex";

  if(histChart){ histChart.destroy(); histChart = null; }
  const histCanvas = document.getElementById("histChart");
  if(histCanvas){
    histChart = new Chart(histCanvas, {
      type: "bar",
      data: { labels: histLabels, datasets: [{ label: "Contributions", data: histData,
        backgroundColor: "rgba(42,106,223,0.55)", borderColor: "rgba(31,75,153,0.85)", borderWidth: 1 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: "#e5e7eb", autoSkip: false, maxRotation: 60, minRotation: 0 }, grid: { color: "rgba(229,231,235,.10)" } },
          y: { beginAtZero: true, ticks: { color: "#e5e7eb" }, grid: { color: "rgba(229,231,235,.10)" } }
        }
      }
    });
  }

  const pieValues = [Number(pot)||0, Number(appState.foundation)||0, Number(outstanding)||0];
  const hasPieData = pieValues.some(v => (Number(v) || 0) > 0);

  const pieOverlay = document.getElementById("pieNoData");
  if(pieOverlay) pieOverlay.style.display = hasPieData ? "none" : "flex";

  if(pieChart){ pieChart.destroy(); pieChart = null; }
  const pieCanvas = document.getElementById("pieChart");
  if(pieCanvas){
    pieChart = new Chart(pieCanvas, {
      type: "pie",
      data: {
        labels: ["Njangi Pot", "Foundation", "Loans"],
        datasets: [{
          data: pieValues,
          backgroundColor: ["rgba(42,106,223,0.65)","rgba(20,184,166,0.55)","rgba(245,158,11,0.55)"],
          borderColor: "rgba(229,231,235,.12)",
          borderWidth: 1
        }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom", labels:{ color:"#e5e7eb" } } } }
    });
  }

  refreshSuretyDropdown();
}

/* ===========================
   WRITES (History)
=========================== */
async function addHistoryRow(type, member, amount, interestPercent=0, totalDue=null){
  const r = await sb.from("history").insert([{ type, member, amount, interest_percent:interestPercent, total_due:totalDue }]);
  if(r.error) appendErr("history insert: " + r.error.message);
}

async function approveProfile(profileId){
  if(!window.isAdmin) return toast("Admin only");
  const up = await sb.from("profiles").update({ approved:true }).eq("id", profileId);
  if(up.error) return toast("approve failed: " + up.error.message);
  toast("Approved");
  await reloadAll();
}

/* MEMBERS */
async function addMember(){
  const name = document.getElementById("mName").value.trim();
  const email = (document.getElementById("mEmail").value.trim() || "").toLowerCase();
  const phone = document.getElementById("mPhone").value.trim();
  const hasBenefits = document.getElementById("mBenefits").value === "true";
  if(!name) return toast("Enter member name");
  if(!email) return toast("Enter member email (required)");

  const pos = members.length ? (Math.max(...members.map(x => Number(x.position || 0))) + 1) : 1;

  const r = await sb.from("members").insert([{ name, email, phone, has_benefits: hasBenefits, position: pos }]);
  if (r.error) return toast(r.error.message);

  await addHistoryRow("Member Added", name, 0, 0, null);
  document.getElementById("mName").value = "";
  document.getElementById("mEmail").value = "";
  document.getElementById("mPhone").value = "";
  await reloadAll();
  toast("Member added (registered for signup)");
}

/* CONTRIBUTIONS */
async function addContribution(){
  const memberIdStr = document.getElementById("cMember").value;
  const amt = Number(document.getElementById("cAmount").value || 0);

  if(!memberIdStr) return toast("Select member");
  if(!amt || amt <= 0) return toast("Enter amount");
  if(amt % 500 !== 0) return toast("Must be multiple of 500");

  const m = members.find(x => String(x.id) === String(memberIdStr));
  const memberName = m?.name || "";

  const row = { member_id: memberIdStr, amount: amt, kind: "contribution" };
  if(latestSession?.id) row.session_id = latestSession.id;

  const ins = await sb.from("contributions").insert([row]);
  if (ins.error) return toast(ins.error.message);

  const prev = Number(contribTotalsByMember[String(memberIdStr)] || 0);
  const newTotal = prev + amt;
  await addHistoryRow("Contribution", memberName || ("member_id=" + memberIdStr), amt, 0, newTotal);

  document.getElementById("cAmount").value = "";
  await reloadAll();
  toast("Saved");
}

/* FOUNDATION PAYMENTS */
async function addFoundationPayment(){
  if(!window.isAdmin) return toast("Admin only");

  const memberIdStr = document.getElementById("fpMember").value;
  const paid = Number(document.getElementById("fpPaid").value || 0);
  const pending = Number(document.getElementById("fpPending").value || 0);
  const status = String(document.getElementById("fpStatus").value || "pending");
  const notes = (document.getElementById("fpNotes").value || "").trim();

  if(!memberIdStr) return toast("Select member");
  if((paid <= 0) && (pending < 0)) return toast("Enter amount paid (or pending)");

  const ins = await sb.from("foundation_payments").insert([{
    member_id: memberIdStr,
    amount_paid: paid,
    amount_pending: pending,
    status: status,
    notes: notes,
    date_paid: new Date().toISOString()
  }]);
  if(ins.error) return toast("foundation_payments insert: " + ins.error.message);

  const mem = members.find(x => String(x.id) === String(memberIdStr));
  if(mem){
    const upM = await sb.from("members").update({
      foundation_contrib: (Number(mem.foundation_contrib||0) + paid)
    }).eq("id", mem.id);
    if(upM.error) appendErr("members foundation_contrib update: " + upM.error.message);
  }

  const upS = await sb.from("app_state").update({
    foundation: (Number(appState.foundation||0) + paid),
    updated_at: new Date().toISOString()
  }).eq("id", 1);
  if(upS.error) appendErr("app_state foundation update: " + upS.error.message);

  await addHistoryRow("Foundation Payment", mem?.name || ("member_id=" + memberIdStr), paid, 0, null);

  document.getElementById("fpPaid").value = "";
  document.getElementById("fpPending").value = "";
  document.getElementById("fpNotes").value = "";
  document.getElementById("fpStatus").value = "pending";

  await reloadAll();
  toast("Saved");
}

/* FINES (YOUR PROMPT D: cumulative total_fines_accumulated) */
async function addFine(){
  if(!window.isAdmin) return toast("Admin only");

  const memberIdStr = document.getElementById("fineMember").value;
  const amt = Number(document.getElementById("fineAmount").value || 0);
  const reason = (document.getElementById("fineReason").value || "").trim();
  if(!memberIdStr) return toast("Select member");
  if(!amt || amt <= 0) return toast("Enter fine amount");

  const m = members.find(x => String(x.id) === String(memberIdStr));
  const memberName = m?.name || "";

  const ins = await sb.from("fines").insert([{
    member_id: memberIdStr,
    member_name: memberName,
    amount: amt,
    reason: reason || null,
    status: "unpaid",
    created_at: new Date().toISOString()
  }]);
  if(ins.error) return toast("fines insert: " + ins.error.message);

  // ✅ cumulative fines total (never decreases)
  const curTotal = Number(m?.total_fines_accumulated || 0);
  const upM = await sb.from("members").update({
    total_fines_accumulated: curTotal + amt
  }).eq("id", memberIdStr);
  if(upM.error) appendErr("members total_fines_accumulated update: " + upM.error.message);

  await addHistoryRow("Fine", memberName || ("member_id=" + memberIdStr), amt, 0, null);

  document.getElementById("fineAmount").value = "";
  document.getElementById("fineReason").value = "";
  await reloadAll();
  toast("Saved");
}

async function markFinePaid(fineId){
  if(!window.isAdmin) return toast("Admin only");
  const up = await sb.from("fines").update({ status:"paid", updated_at:new Date().toISOString() }).eq("id", fineId);
  if(up.error) return toast("fine update: " + up.error.message);

  const f = (fines || []).find(x => Number(x.id) === Number(fineId));
  if(f) await addHistoryRow("Fine Paid", f.member_name || "Member", Number(f.amount||0), 0, null);

  await reloadAll();
  toast("Marked paid");
}

/* LOANS: request/issue obey eligibility + interest rules */
function initialInterest(principal){
  return Math.round(Number(principal||0) * INTEREST_RATE);
}

async function requestLoan(){
  const memberId = window.currentMemberId != null ? String(window.currentMemberId) : document.getElementById("lMember").value;
  const suretyMemberId = document.getElementById("lSuretyMember").value;
  const amt = Number(document.getElementById("lAmount").value||0);

  if(!memberId) return toast("Borrower missing");
  if(!amt||amt<=0) return toast("Enter loan amount");

  // eligibility check (prompt A)
  const dec = eligibilityDecision(memberId, suretyMemberId, amt);
  if(!dec.ok) return toast(dec.reason);

  const borrower = members.find(x=>String(x.id)===String(memberId));
  const surety = members.find(x=>String(x.id)===String(suretyMemberId));
  const borrowerName = borrower?.name || "Unknown";
  const suretyName = (dec.mode === "self") ? borrowerName : (surety?.name || "Unknown");

  const interest = initialInterest(amt);
  const totalDue = amt + interest;

  const r = await sb.from("loans").insert([{
    borrower_member_id: memberId,
    borrower_name: borrowerName,
    surety_member_id: (dec.mode === "self") ? memberId : suretyMemberId,
    surety_name: (dec.mode === "self") ? borrowerName : suretyName,
    principal: amt,
    principal_current: amt,
    interest: interest,
    total_due: totalDue,
    total_interest_accumulated: interest,
    borrow_date: new Date().toISOString().slice(0,10),
    last_interest_at: new Date().toISOString(),
    interest_cycle_days: INTEREST_CYCLE_DAYS,
    status: "pending",
    created_at: new Date().toISOString()
  }]).select().single();
  if(r.error) return toast("loans insert: " + r.error.message);

  // ledger initial
  const led = await sb.from("loan_interest_events").insert([{
    loan_id: r.data.id,
    member_id: memberId,
    event_type: "initial",
    cycle_no: 0,
    principal_before: amt,
    interest_generated: interest,
    unpaid_interest_capitalized: 0,
    principal_after: amt
  }]);
  if(led.error) appendErr("ledger insert: " + led.error.message);

  await addHistoryRow("Loan Requested", borrowerName, amt, 5, totalDue);

  document.getElementById("lAmount").value="";
  await reloadAll();
  toast("Loan requested (pending admin approval)");
}

/* Admin issues loan: deduct foundation cash (principal only) */
async function issueLoan(){
  if(!window.isAdmin) return toast("Admin only");

  const memberIdStr = document.getElementById("lMember").value;
  const suretyMemberIdStr = document.getElementById("lSuretyMember").value;
  const amt = Number(document.getElementById("lAmount").value||0);

  if(!memberIdStr) return toast("Select borrower");
  if(!amt || amt <= 0) return toast("Enter loan amount");

  const dec = eligibilityDecision(memberIdStr, suretyMemberIdStr, amt);
  if(!dec.ok) return toast(dec.reason);

  const borrower = members.find(x=>String(x.id)===String(memberIdStr));
  const surety = members.find(x=>String(x.id)===String(suretyMemberIdStr));
  if(!borrower) return toast("Borrower not found");

  const foundation = Number(appState.foundation || 0);
  if(amt > foundation) return toast("Loan exceeds foundation cash (principal)");

  const interest = initialInterest(amt);
  const totalDue = amt + interest;

  const suretyId = (dec.mode === "self") ? borrower.id : surety?.id;
  const suretyName = (dec.mode === "self") ? borrower.name : (surety?.name || "Unknown");

  const ins = await sb.from("loans").insert([{
    borrower_member_id: memberIdStr,
    borrower_name: borrower.name,
    surety_member_id: suretyId,
    surety_name: suretyName,
    principal: amt,
    principal_current: amt,
    interest: interest,
    total_due: totalDue,
    total_interest_accumulated: interest,
    borrow_date: new Date().toISOString().slice(0,10),
    last_interest_at: new Date().toISOString(),
    interest_cycle_days: INTEREST_CYCLE_DAYS,
    status: "active",
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  }]).select().single();
  if(ins.error) return toast("loans insert: " + ins.error.message);

  // ledger initial
  const led = await sb.from("loan_interest_events").insert([{
    loan_id: ins.data.id,
    member_id: borrower.id,
    event_type: "initial",
    cycle_no: 0,
    principal_before: amt,
    interest_generated: interest,
    unpaid_interest_capitalized: 0,
    principal_after: amt
  }]);
  if(led.error) appendErr("ledger insert: " + led.error.message);

  // update member loan_due
  const upM = await sb.from("members").update({
    loan_due: (Number(borrower.loan_due||0) + totalDue)
  }).eq("id", borrower.id);
  if(upM.error) return toast("members update: " + upM.error.message);

  // deduct foundation cash by principal (not total_due)
  const upS = await sb.from("app_state").update({
    foundation: foundation - amt,
    total_interest_generated: (Number(appState.total_interest_generated||0) + interest),
    updated_at: new Date().toISOString()
  }).eq("id",1);
  if(upS.error) return toast("app_state update: " + upS.error.message);

  await addHistoryRow("Loan Issued", borrower.name, amt, 5, totalDue);

  document.getElementById("lAmount").value = "";
  await reloadAll();
  toast("Loan issued");
}

/* Admin approves pending loan: activates + deducts foundation */
async function approveLoan(loanId){
  if(!window.isAdmin) return toast("Admin only");

  const got = await sb.from("loans").select("*").eq("id", loanId).maybeSingle();
  if(got.error) return toast("load loan: " + got.error.message);
  const loan = got.data;
  if(!loan) return toast("Loan not found");

  if(String(loan.status||"").toLowerCase() !== "pending"){
    return toast("Only pending loans can be approved");
  }

  const foundation = Number(appState.foundation || 0);
  const principal = Number(loan.principal_current ?? loan.principal ?? 0);

  if(principal > foundation) return toast("Loan exceeds foundation cash (principal)");

  // mark active
  let r = await sb.from("loans").update({
    status: "active",
    updated_at: new Date().toISOString()
  }).eq("id", loanId);
  if(r.error) return toast("loan status update: " + r.error.message);

  // member loan_due add this loan total_due
  const borrowerId = loan.borrower_member_id;
  const mem = members.find(m => String(m.id) === String(borrowerId));
  const curDue = Number(mem?.loan_due || 0);

  r = await sb.from("members").update({ loan_due: curDue + Number(loan.total_due||0) }).eq("id", borrowerId);
  if(r.error) return toast("members loan_due update: " + r.error.message);

  // deduct foundation principal + add interest to app_state total
  r = await sb.from("app_state").update({
    foundation: foundation - principal,
    total_interest_generated: (Number(appState.total_interest_generated)||0) + Number(loan.total_interest_accumulated||loan.interest||0),
    updated_at:new Date().toISOString()
  }).eq("id",1);
  if(r.error) return toast("app_state update: " + r.error.message);

  await addHistoryRow("Loan Approved", loan.borrower_name || "Borrower", principal, 5, Number(loan.total_due||0));

  await reloadAll();
  toast("Loan approved");
}

/* REPAYMENTS:
   - Apply repayment to oldest active loan(s) for borrower
   - Update loans.total_due / principal_current (if overpays interest into principal)
   - Keep members.loan_due synced
*/
async function repayLoan(){
  const memberIdStr = document.getElementById("rMember").value;
  let amt = Number(document.getElementById("rAmount").value || 0);

  if(!memberIdStr) return toast("Select borrower");
  if(!amt || amt <= 0) return toast("Enter repayment amount");

  // fetch active loans oldest first
  const l = await sb.from("loans")
    .select("*")
    .eq("borrower_member_id", memberIdStr)
    .eq("status", "active")
    .order("created_at", { ascending: true })
    .limit(50);

  if(l.error) return toast("load active loans: " + l.error.message);
  const active = l.data || [];
  if(!active.length) return toast("No active loan for this borrower");

  for(const loan of active){
    if(amt <= 0) break;

    const loanId = loan.id;
    let totalDue = Number(loan.total_due || 0);
    if(totalDue <= 0) continue;

    const pay = Math.min(amt, totalDue);
    amt -= pay;

    // reduce total_due
    totalDue = Math.max(0, totalDue - pay);

    // if total_due falls below principal_current, it means principal got paid too
    let principalCurrent = Number(loan.principal_current ?? loan.principal ?? 0);
    if(totalDue < principalCurrent){
      principalCurrent = totalDue; // remainder is principal outstanding
    }

    // update loan
    const upL = await sb.from("loans").update({
      total_due: totalDue,
      principal_current: principalCurrent,
      updated_at: new Date().toISOString(),
      status: (totalDue === 0 ? "cleared" : "active")
    }).eq("id", loanId);
    if(upL.error) appendErr("repay: loan update: " + upL.error.message);

    // insert repayment row linked to this loan
    const borrower = members.find(x=>String(x.id)===String(memberIdStr));
    const borrowerName = borrower?.name || null;

    const ins = await sb.from("repayments").insert([{
      loan_id: loanId,
      member_id: memberIdStr,
      member_name: borrowerName,
      amount: pay,
      created_at: new Date().toISOString()
    }]);
    if(ins.error) appendErr("repayments insert: " + ins.error.message);

    await addHistoryRow("Repayment", borrowerName || ("member_id=" + memberIdStr), pay, 0, totalDue);
  }

  // recompute member loan_due from DB (authoritative)
  const sum = await sb.from("loans")
    .select("total_due")
    .eq("borrower_member_id", memberIdStr)
    .eq("status","active")
    .limit(1000);

  if(sum.error){
    appendErr("recompute loan_due: " + sum.error.message);
  } else {
    const newDue = (sum.data || []).reduce((s,r)=> s + Number(r.total_due||0), 0);
    const upM = await sb.from("members").update({ loan_due: newDue }).eq("id", memberIdStr);
    if(upM.error) appendErr("members loan_due recompute update: " + upM.error.message);
  }

  document.getElementById("rAmount").value = "";
  await reloadAll();
  toast("Saved repayment");
}

/* PAYOUTS (UNCHANGED) */
async function runPayout(){
  if(!window.isAdmin) return toast("Admin only");
  if(!members.length) return toast("No members");

  const pot = members.reduce((s,x)=>s+(Number(x.contributed)||0),0);
  if(pot <= 0) return toast("Pot is 0");

  const idx = Number(appState.next_payout_index||0);
  const nextMember = members[idx % members.length];
  const payoutDate = appState.next_payout_date || "2026-01-03";

  const ins = await sb.from("payouts").insert([{
    member_id: nextMember.id,
    member_name: nextMember.name,
    payout_amount: pot,
    payout_date: payoutDate,
    created_at: new Date().toISOString()
  }]);
  if(ins.error) return toast("payout insert: " + ins.error.message);

  const upM = await sb.from("members").update({
    payout_total: (Number(nextMember.payout_total||0) + pot),
    has_benefits: true
  }).eq("id", nextMember.id);
  if(upM.error) appendErr("members payout update: " + upM.error.message);

  const upC = await sb.from("contributions").update({
    kind: "paid",
    updated_at: new Date().toISOString()
  }).eq("kind","contribution");
  if(upC.error) appendErr("contributions mark paid: " + upC.error.message);

  const d = fromIso(payoutDate);
  const nextD = new Date(d.getTime() + 14*24*60*60*1000);
  const nextDateStr = nextD.toISOString().slice(0,10);

  const upS = await sb.from("app_state").update({
    next_payout_index: (idx + 1),
    next_payout_date: nextDateStr,
    updated_at: new Date().toISOString()
  }).eq("id", 1);
  if(upS.error) appendErr("app_state payout update: " + upS.error.message);

  await addHistoryRow("Payout", nextMember.name, pot, 0, null);

  await reloadAll();
  toast("Payout complete");
}

/* ===========================
   INIT
=========================== */
function wireLoanInputs(){
  const borrowerSel = document.getElementById("lMember");
  const amtInput = document.getElementById("lAmount");
  if(borrowerSel) borrowerSel.addEventListener("change", refreshSuretyDropdown);
  if(amtInput) amtInput.addEventListener("input", refreshSuretyDropdown);
}

/* Auto-handle refresh and sign-in/out changes */
sb.auth.onAuthStateChange(async (_event) => {
  const ok = await enforceAdminGate();
  if(ok) await reloadAll();
});

document.addEventListener("DOMContentLoaded", async () => {
  wireLoanInputs();
  const ok = await enforceAdminGate();
  if(ok) await reloadAll();
});
</script>
</body>
</html>

